
<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>X Pro Library</title>
<!-- ImageKit SDK -->
<script src="https://unpkg.com/imagekit-javascript/dist/imagekit.min.js"></script>
<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config = {
darkMode: "class",
theme: {
extend: {
fontFamily: { sans: ["Inter", "sans-serif"] },
animation: { "fade-in": "fadeIn 0.3s ease-out" },
keyframes: {
fadeIn: {
"0%": { opacity: "0", transform: "translateY(10px)" },
"100%": { opacity: "1", transform: "translateY(0)" },
},
},
},
},
};
</script>
<!-- Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet" />
<style>
::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
.dark ::-webkit-scrollbar-thumb { background: #475569; }
.glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); }
.dark .glass { background: rgba(15, 23, 42, 0.8); }
.line-clamp-3 { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
[x-cloak] { display: none !important; }
/* Animation for notification banner */
@keyframes slideInRight {
from { transform: translateX(100%); opacity: 0; }
to { transform: translateX(0); opacity: 1; }
}
.animate-slide-in { animation: slideInRight 0.5s ease-out forwards; }

/* Carousel styles */
.carousel-track { transition: transform 0.3s ease-in-out; }
</style>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-white transition-colors duration-300 font-sans flex flex-col min-h-screen">
<!-- Toast Container (Standard Alerts) -->
<div id="toast-container" class="fixed top-5 right-5 z-[60] flex flex-col gap-2 pointer-events-none"></div>
<!-- Notification Container (Rich Push Notifications) -->
<div id="notification-container" class="fixed bottom-5 right-5 z-[60] flex flex-col gap-3 pointer-events-none"></div>
<!-- Navigation -->
<nav class="fixed w-full z-40 top-0 border-b border-slate-200 dark:border-slate-800 glass">
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
<div class="flex justify-between h-16 items-center">
<div class="flex items-center gap-6">
<div class="flex items-center cursor-pointer" onclick="window.scrollTo(0,0); app.switchPublicView('home')">
<span class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600" id="nav-logo">X Pro</span>
</div>
<!-- New Insider Link -->
<button onclick="app.requestInsiderAccess()" class="hidden md:flex items-center gap-2 text-sm font-bold text-amber-600 dark:text-amber-400 hover:text-amber-700 dark:hover:text-amber-300 transition">
<i class="fa-solid fa-lock"></i> Insider Deals
</button>
</div>
code
Code
<div class="hidden md:flex flex-1 max-w-lg mx-8 relative">
      <input type="text" id="global-search" placeholder="Search resources..." class="w-full pl-10 pr-4 py-2 rounded-full bg-slate-100 dark:bg-slate-800 border-none focus:ring-2 focus:ring-blue-500 transition-all" />
      <i class="fa-solid fa-search absolute left-3.5 top-3 text-slate-400"></i>
    </div>

    <div class="flex items-center gap-4">
      <button id="theme-toggle" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-800 transition">
        <i class="fa-solid fa-moon"></i>
      </button>
      <button id="auth-btn" class="px-4 py-2 rounded-lg font-medium text-sm bg-blue-600 text-white hover:bg-blue-700 transition shadow-lg shadow-blue-500/30">
        Sign In
      </button>
      <button id="admin-panel-btn" class="hidden px-4 py-2 rounded-lg font-medium text-sm bg-purple-600 text-white hover:bg-purple-700 transition shadow-lg">
        Admin
      </button>
    </div>
  </div>
  <!-- Mobile Insider Link -->
  <div class="md:hidden py-2 border-t border-slate-200 dark:border-slate-800 flex justify-center">
     <button onclick="app.requestInsiderAccess()" class="flex items-center gap-2 text-xs font-bold text-amber-600 dark:text-amber-400">
        <i class="fa-solid fa-lock"></i> Access Insider Deals
      </button>
  </div>
</div>
</nav>
<!-- Admin Dashboard -->
<div id="admin-view" class="hidden pt-20 pb-10 min-h-screen bg-slate-100 dark:bg-slate-900">
<div class="max-w-7xl mx-auto px-4">
<div class="flex justify-between items-center mb-6">
<h2 class="text-3xl font-bold text-slate-800 dark:text-white">Admin Dashboard</h2>
<div class="flex gap-3">
<button onclick="app.closeAdmin()" class="px-4 py-2 bg-slate-200 dark:bg-slate-700 rounded-lg hover:opacity-80">Exit Admin</button>
<button onclick="app.openPostModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-lg">+ New Post</button>
</div>
</div>
code
Code
<div class="flex gap-4 border-b border-slate-300 dark:border-slate-700 mb-6 overflow-x-auto">
    <button onclick="app.switchAdminTab('posts')" id="tab-btn-posts" class="pb-2 border-b-2 border-blue-600 font-semibold px-2 whitespace-nowrap">Posts</button>
    <button onclick="app.switchAdminTab('deals')" id="tab-btn-deals" class="pb-2 border-transparent text-slate-500 hover:text-slate-800 dark:hover:text-white px-2 whitespace-nowrap">Insider Deals</button>
    <button onclick="app.switchAdminTab('settings')" id="tab-btn-settings" class="pb-2 border-transparent text-slate-500 hover:text-slate-800 dark:hover:text-white px-2 whitespace-nowrap">Settings</button>
    <button onclick="app.switchAdminTab('notifications')" id="tab-btn-notifications" class="pb-2 border-transparent text-slate-500 hover:text-slate-800 dark:hover:text-white px-2 whitespace-nowrap">Send Notification</button>
  </div>

  <!-- Admin Posts Tab -->
  <div id="admin-posts-tab" class="overflow-x-auto bg-white dark:bg-slate-800 rounded-xl shadow-sm">
    <table class="w-full text-left text-sm">
      <thead class="bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-300 uppercase">
        <tr>
          <th class="p-4">Title</th>
          <th class="p-4">Type</th>
          <th class="p-4">Score</th>
          <th class="p-4">Status</th>
          <th class="p-4 text-right">Actions</th>
        </tr>
      </thead>
      <tbody id="admin-posts-table-body" class="divide-y divide-slate-100 dark:divide-slate-700"></tbody>
    </table>
  </div>

  <!-- Admin Insider Deals Tab -->
  <div id="admin-deals-tab" class="hidden">
    <div class="flex justify-end mb-4">
       <button onclick="app.openDealEditor()" class="px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 shadow-lg">+ New Deal</button>
    </div>
    <div class="overflow-x-auto bg-white dark:bg-slate-800 rounded-xl shadow-sm">
      <table class="w-full text-left text-sm">
        <thead class="bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-300 uppercase">
          <tr>
            <th class="p-4">Deal Title</th>
            <th class="p-4">Status</th>
            <th class="p-4">Expiry</th>
            <th class="p-4 text-right">Actions</th>
          </tr>
        </thead>
        <tbody id="admin-deals-table-body" class="divide-y divide-slate-100 dark:divide-slate-700"></tbody>
      </table>
    </div>
  </div>

  <!-- Admin Settings Tab -->
  <div id="admin-settings-tab" class="hidden max-w-2xl bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm">
    <form id="settings-form" class="space-y-4">
      <div>
        <label class="block text-sm font-medium mb-1">Site Name</label>
        <input type="text" name="siteName" class="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600" />
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Hero Title</label>
        <input type="text" name="heroTitle" class="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600" />
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Hero Subtitle</label>
        <input type="text" name="heroSubtitle" class="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600" />
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Primary Theme Color</label>
        <select name="primaryTheme" class="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600">
          <option value="blue">Blue</option>
          <option value="emerald">Emerald</option>
          <option value="indigo">Indigo</option>
          <option value="rose">Rose</option>
          <option value="amber">Amber</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Allowed Admin Email (Be Careful)</label>
        <input type="email" name="allowedAdminEmail" class="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600" />
      </div>
      <button type="submit" class="w-full py-2 bg-green-600 text-white rounded hover:bg-green-700">Save Settings</button>
    </form>
  </div>

  <!-- Admin Notifications Tab -->
  <div id="admin-notifications-tab" class="hidden max-w-2xl bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm">
    <h3 class="text-xl font-bold mb-4">Send Push Notification</h3>
    <p class="text-sm text-slate-500 mb-6">This will display a live pop-up for all users currently on the site.</p>
    
    <form id="notification-form" class="space-y-4">
      <div>
        <label class="block text-sm font-medium mb-1">Select Post (Optional Auto-fill)</label>
        <select id="notif-post-select" class="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600" onchange="app.fillNotificationForm(this.value)">
          <option value="">-- Manual Entry --</option>
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">Notification Title</label>
        <input type="text" name="title" required class="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600" />
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">Short Message</label>
        <input type="text" name="message" required placeholder="e.g. New Alpha Dropped!" class="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600" />
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium mb-1">Image URL</label>
          <input type="text" name="imageUrl" class="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Target Post ID</label>
          <input type="text" name="postId" placeholder="ID for deep link" class="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600" />
        </div>
      </div>

      <button type="submit" class="w-full py-3 bg-indigo-600 text-white font-bold rounded hover:bg-indigo-700 shadow-lg">
        <i class="fa-solid fa-paper-plane mr-2"></i> Send Notification
      </button>
    </form>
  </div>

</div>
</div>
<!-- Main Content Wrapper -->
<main id="public-view" class="pt-24 pb-12 px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto flex-1 w-full">
code
Code
<!-- STANDARD POSTS VIEW -->
<div id="standard-view-content">
    <div class="text-center mb-12 animate-fade-in">
    <h1 id="hero-title" class="text-4xl md:text-6xl font-extrabold tracking-tight mb-4 bg-clip-text text-transparent bg-gradient-to-r from-slate-900 to-slate-600 dark:from-white dark:to-slate-400">
        Discover Excellence
    </h1>
    <p id="hero-subtitle" class="text-lg text-slate-600 dark:text-slate-400 max-w-2xl mx-auto">
        Curated Alpha Posts & AI Tools for the modern professional.
    </p>
    </div>

    <div class="sticky top-16 z-30 bg-slate-50/90 dark:bg-slate-950/90 backdrop-blur py-4 mb-8 border-b border-slate-200 dark:border-slate-800">
    <div class="flex flex-col gap-4">
        <div class="flex flex-wrap items-center justify-center gap-3">
        <div class="md:hidden w-full mb-2">
            <input type="text" id="mobile-search" placeholder="Search..." class="w-full p-2 rounded border dark:bg-slate-800 dark:border-slate-700" />
        </div>

        <div class="bg-slate-200 dark:bg-slate-800 p-1 rounded-lg inline-flex">
            <button onclick="app.setFilter('type', 'all')" class="filter-type-btn px-4 py-1.5 rounded-md text-sm font-medium transition active-filter" data-val="all">All</button>
            <button onclick="app.setFilter('type', 'alpha')" class="filter-type-btn px-4 py-1.5 rounded-md text-sm font-medium transition" data-val="alpha">Alpha</button>
            <button onclick="app.setFilter('type', 'tool')" class="filter-type-btn px-4 py-1.5 rounded-md text-sm font-medium transition" data-val="tool">AI Tools</button>
            <button onclick="app.setFilter('type', 'xscore')" class="filter-type-btn px-4 py-1.5 rounded-md text-sm font-medium transition" data-val="xscore">X Score</button>
        </div>

        <select id="category-filter" onchange="app.setFilter('category', this.value)" class="p-2 pr-8 rounded-lg bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-sm focus:ring-2 focus:ring-blue-500">
            <option value="all">All Categories</option>
        </select>
        </div>

        <!-- X Score Filters -->
        <div id="xscore-filter-row" class="hidden flex flex-wrap justify-center gap-2">
        <button onclick="app.setFilter('xScoreRange', 'all')" class="filter-xscore-btn px-3 py-1 rounded-full border border-slate-300 dark:border-slate-700 text-xs font-semibold active-score" data-val="all">Any Score</button>
        <button onclick="app.setFilter('xScoreRange', '100-200')" class="filter-xscore-btn px-3 py-1 rounded-full border border-slate-300 dark:border-slate-700 text-xs hover:bg-slate-100 dark:hover:bg-slate-800 transition" data-val="100-200">100-200</button>
        <button onclick="app.setFilter('xScoreRange', '200-400')" class="filter-xscore-btn px-3 py-1 rounded-full border border-slate-300 dark:border-slate-700 text-xs hover:bg-slate-100 dark:hover:bg-slate-800 transition" data-val="200-400">200-400</button>
        <button onclick="app.setFilter('xScoreRange', '400-800')" class="filter-xscore-btn px-3 py-1 rounded-full border border-slate-300 dark:border-slate-700 text-xs hover:bg-slate-100 dark:hover:bg-slate-800 transition" data-val="400-800">400-800</button>
        <button onclick="app.setFilter('xScoreRange', '800-1000')" class="filter-xscore-btn px-3 py-1 rounded-full border border-slate-300 dark:border-slate-700 text-xs hover:bg-slate-100 dark:hover:bg-slate-800 transition" data-val="800-1000">800-1000</button>
        </div>
    </div>
    </div>

    <div id="posts-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    <!-- Skeletons -->
    <div class="h-80 bg-slate-200 dark:bg-slate-800 rounded-xl animate-pulse"></div>
    <div class="h-80 bg-slate-200 dark:bg-slate-800 rounded-xl animate-pulse"></div>
    <div class="h-80 bg-slate-200 dark:bg-slate-800 rounded-xl animate-pulse"></div>
    </div>

    <div id="empty-state" class="hidden text-center py-20">
    <i class="fa-regular fa-folder-open text-6xl text-slate-300 mb-4"></i>
    <p class="text-xl text-slate-500">No results found.</p>
    </div>
</div>

<!-- INSIDER DEALS VIEW -->
<div id="insider-view" class="hidden animate-fade-in">
    <div class="flex flex-col items-center mb-10">
        <div class="inline-flex items-center gap-2 bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-400 px-4 py-1.5 rounded-full text-sm font-bold mb-4">
            <i class="fa-solid fa-lock-open"></i> Access Granted: CryptoAIInsider
        </div>
        <h1 class="text-4xl md:text-5xl font-extrabold text-center mb-2">Insider Deals</h1>
        <p class="text-slate-600 dark:text-slate-400 max-w-2xl text-center">Exclusive time-limited offers, premium tools, and high-level alpha.</p>
        <button onclick="app.lockInsider()" class="mt-4 text-xs text-red-500 hover:text-red-700 hover:underline">Lock Access & Return Home</button>
    </div>

    <!-- Deals Grid -->
    <div id="insider-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
    
    <div id="insider-empty" class="hidden text-center py-16">
        <i class="fa-solid fa-gem text-6xl text-slate-200 dark:text-slate-800 mb-4"></i>
        <p class="text-slate-500">No active deals right now. Check back later.</p>
    </div>
</div>
</main>
<!-- Footer -->
<footer class="w-full py-8 bg-slate-100 dark:bg-slate-900 border-t border-slate-200 dark:border-slate-800">
<div class="max-w-7xl mx-auto px-4 text-center">
<p class="text-sm text-slate-500 dark:text-slate-400">
Build By <a href="https://x.com/ai_elon_musk_" target="_blank" class="font-bold text-blue-600 hover:text-blue-700 hover:underline transition">CryptoAI_Insider</a>
</p>
</div>
</footer>
<!-- Post Details Modal (Standard) -->
<div id="post-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
<div class="bg-white dark:bg-slate-900 w-full max-w-4xl max-h-[90vh] rounded-2xl shadow-2xl overflow-hidden flex flex-col relative animate-fade-in">
<button onclick="app.closeModals()" class="absolute top-4 right-4 z-10 bg-black/20 hover:bg-black/40 text-white rounded-full p-2 w-10 h-10 backdrop-blur">
<i class="fa-solid fa-xmark"></i>
</button>
<div class="overflow-y-auto custom-scrollbar flex-1">
<div class="relative h-64 md:h-80 w-full">
<img id="modal-img" src="" class="w-full h-full object-cover" />
<div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-black/80 to-transparent p-6 pt-20">
<div class="flex items-center gap-3 mb-2">
<span id="modal-type" class="px-2 py-0.5 rounded text-xs uppercase font-bold tracking-wider bg-white text-black"></span>
<span id="modal-score-container" class="hidden px-2 py-0.5 rounded text-xs font-bold bg-yellow-500 text-black"></span>
</div>
<h2 id="modal-title" class="text-3xl font-bold text-white"></h2>
</div>
</div>
<div class="p-6 md:p-8">
<div class="flex flex-wrap gap-2 mb-6" id="modal-tags"></div>
<p id="modal-desc" class="text-lg text-slate-600 dark:text-slate-300 font-medium mb-6 leading-relaxed"></p>
<div id="modal-content" class="prose dark:prose-invert max-w-none text-slate-700 dark:text-slate-400 mb-8 whitespace-pre-wrap"></div>
code
Code
<!-- Social Buttons Row -->
      <div id="modal-social-row" class="flex flex-wrap gap-3 mb-4 empty:hidden"></div>

      <div class="flex gap-4 pt-4 border-t border-slate-200 dark:border-slate-800">
        <a id="modal-link" href="#" target="_blank" class="flex-1 text-center bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-semibold transition shadow-lg shadow-blue-500/20">
          Visit Resource <i class="fa-solid fa-external-link-alt ml-2"></i>
        </a>
        <button onclick="app.sharePost()" class="px-6 py-3 bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 rounded-xl font-semibold hover:bg-slate-200 dark:hover:bg-slate-700 transition">
          <i class="fa-solid fa-share-nodes"></i>
        </button>
      </div>
    </div>
  </div>
</div>
</div>
<!-- Insider Deal Modal -->
<div id="deal-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
<div class="bg-white dark:bg-slate-900 w-full max-w-5xl max-h-[95vh] rounded-3xl shadow-2xl overflow-hidden flex flex-col relative animate-fade-in">
<button onclick="app.closeModals()" class="absolute top-4 right-4 z-20 bg-black/40 hover:bg-black/60 text-white rounded-full w-10 h-10 flex items-center justify-center backdrop-blur">
<i class="fa-solid fa-xmark"></i>
</button>
code
Code
<div class="flex flex-col lg:flex-row h-full">
        <!-- Carousel Side -->
        <div class="w-full lg:w-1/2 bg-black relative flex items-center justify-center h-64 lg:h-auto overflow-hidden group">
            <div id="deal-carousel-track" class="flex w-full h-full transition-transform duration-500">
                <!-- Images injected here -->
            </div>
            <!-- Carousel Controls -->
            <button onclick="app.cycleDealImage(-1)" class="absolute left-2 bg-black/30 hover:bg-black/50 text-white p-3 rounded-full opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-chevron-left"></i></button>
            <button onclick="app.cycleDealImage(1)" class="absolute right-2 bg-black/30 hover:bg-black/50 text-white p-3 rounded-full opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-chevron-right"></i></button>
            <div id="deal-carousel-dots" class="absolute bottom-4 flex gap-2 justify-center w-full"></div>
        </div>

        <!-- Content Side -->
        <div class="w-full lg:w-1/2 flex flex-col h-full overflow-hidden">
            <div class="overflow-y-auto p-8 custom-scrollbar flex-1">
                <div class="flex gap-2 mb-4">
                     <span id="deal-badge-free" class="hidden bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide">Free Offer</span>
                     <span id="deal-badge-expiry" class="hidden bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide"></span>
                </div>
                <h2 id="deal-title" class="text-3xl lg:text-4xl font-extrabold mb-6 leading-tight"></h2>
                <div id="deal-desc" class="prose dark:prose-invert max-w-none text-slate-600 dark:text-slate-300 text-base leading-relaxed whitespace-pre-wrap"></div>
            </div>
            <div id="deal-links-container" class="p-6 bg-slate-50 dark:bg-slate-800/50 border-t border-slate-200 dark:border-slate-800 flex flex-col gap-3">
                <!-- Dynamic Links -->
            </div>
        </div>
    </div>
</div>
</div>
<!-- Gate Modal (Password Protection) -->
<div id="gate-modal" class="fixed inset-0 z-[70] hidden flex items-center justify-center bg-slate-900/90 backdrop-blur-md p-4">
<div class="bg-white dark:bg-slate-950 w-full max-w-md p-8 rounded-2xl shadow-2xl border border-slate-200 dark:border-slate-800 text-center animate-fade-in">
<div class="mb-6 flex justify-center">
<div class="w-16 h-16 bg-amber-100 dark:bg-amber-900/30 rounded-full flex items-center justify-center text-amber-600 dark:text-amber-500 text-3xl">
<i class="fa-solid fa-user-secret"></i>
</div>
</div>
<h2 class="text-2xl font-bold mb-2">Insider Access Required</h2>
<p class="text-slate-500 mb-6 text-sm">Enter your secret code to view the Insider Deals.</p>
<form onsubmit="app.verifyInsiderCode(event)" class="flex flex-col gap-3">
<input type="password" id="gate-code" placeholder="Enter Secret Code" class="w-full p-3 text-center text-lg font-bold tracking-widest rounded-lg border border-slate-300 dark:border-slate-700 bg-slate-50 dark:bg-slate-900 focus:ring-2 focus:ring-amber-500 outline-none" />
<button type="submit" class="w-full py-3 bg-gradient-to-r from-amber-500 to-orange-600 text-white font-bold rounded-lg hover:shadow-lg hover:opacity-90 transition">
Unlock Access
</button>
</form>
<button onclick="app.closeModals()" class="mt-4 text-sm text-slate-400 hover:text-white">Cancel</button>
</div>
</div>
<!-- Auth Modal -->
<div id="auth-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
<div class="bg-white dark:bg-slate-900 w-full max-w-md rounded-2xl shadow-2xl p-8 relative animate-fade-in">
<button onclick="app.closeModals()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 dark:hover:text-white">
<i class="fa-solid fa-xmark text-xl"></i>
</button>
<h2 class="text-2xl font-bold mb-6 text-center">Welcome Back</h2>
<form id="auth-form" class="space-y-4">
<div>
<label class="block text-sm font-medium mb-1">Email</label>
<input type="email" id="auth-email" required class="w-full p-3 rounded-lg border border-slate-300 dark:border-slate-700 dark:bg-slate-800 focus:ring-2 focus:ring-blue-500 outline-none" />
</div>
<div>
<label class="block text-sm font-medium mb-1">Password</label>
<input type="password" id="auth-pass" required class="w-full p-3 rounded-lg border border-slate-300 dark:border-slate-700 dark:bg-slate-800 focus:ring-2 focus:ring-blue-500 outline-none" />
</div>
<button type="submit" class="w-full py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition shadow-lg">
Login / Register
</button>
</form>
<p class="mt-4 text-xs text-center text-slate-500">If the account doesn't exist, we will create one automatically.</p>
<div id="auth-user-info" class="hidden text-center mt-6">
<p class="text-lg font-medium mb-2">Logged in as <span id="user-email-display" class="text-blue-500"></span></p>
<button onclick="app.logout()" class="text-red-500 hover:underline">Sign Out</button>
</div>
</div>
</div>
<!-- Admin Post Editor Modal -->
<div id="editor-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
<div class="bg-white dark:bg-slate-900 w-full max-w-2xl max-h-[90vh] rounded-2xl shadow-2xl overflow-hidden flex flex-col relative animate-fade-in">
<div class="p-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-800">
<h3 class="font-bold text-lg" id="editor-title">Create/Edit Post</h3>
<button onclick="app.closeModals()" class="text-slate-500 hover:text-red-500"><i class="fa-solid fa-xmark text-xl"></i></button>
</div>
<div class="overflow-y-auto p-6 flex-1">
<form id="post-form" class="space-y-4">
<input type="hidden" name="id" />
<div class="grid grid-cols-2 gap-4">
<div>
<label class="block text-xs font-bold uppercase text-slate-500 mb-1">Type</label>
<select name="type" id="editor-type-select" class="w-full p-2 border rounded dark:bg-slate-800 dark:border-slate-700">
<option value="alpha">Alpha Post</option>
<option value="tool">AI Tool</option>
<option value="xscore">X Score</option>
</select>
</div>
code
Code
<!-- Standard Score -->
        <div id="field-std-score">
          <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Score (Optional 0-100)</label>
          <input type="number" name="score" min="0" max="100" class="w-full p-2 border rounded dark:bg-slate-800 dark:border-slate-700 text-slate-500" placeholder="Ignored for X Score" />
        </div>

        <!-- X Score -->
        <div id="field-xscore" class="hidden">
          <label class="block text-xs font-bold uppercase text-slate-500 mb-1">X Score (100-1000)</label>
          <input type="number" name="xScore" min="0" max="1000" class="w-full p-2 border rounded dark:bg-slate-800 dark:border-slate-700" />
        </div>
      </div>

      <div>
        <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Title</label>
        <input type="text" name="title" required class="w-full p-2 border rounded dark:bg-slate-800 dark:border-slate-700" />
      </div>

      <div>
        <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Category</label>
        <input type="text" name="category" placeholder="e.g. Finance, Coding" list="cat-list" required class="w-full p-2 border rounded dark:bg-slate-800 dark:border-slate-700" />
        <datalist id="cat-list"></datalist>
      </div>

      <div>
        <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Image</label>
        <input type="file" id="img-upload" accept="image/*" class="w-full text-sm" />
        <input type="hidden" name="imageUrl" />
        <div id="img-preview" class="mt-2 h-20 w-20 bg-slate-100 rounded bg-cover bg-center hidden"></div>
      </div>

      <div>
        <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Short Description</label>
        <textarea name="description" rows="2" class="w-full p-2 border rounded dark:bg-slate-800 dark:border-slate-700"></textarea>
      </div>

      <div>
        <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Content (Markdown-ish)</label>
        <textarea name="content" rows="6" class="w-full p-2 border rounded dark:bg-slate-800 dark:border-slate-700 font-mono text-sm"></textarea>
      </div>

      <!-- Social Links Section -->
      <div class="border-t border-slate-200 dark:border-slate-700 pt-4 mt-2">
        <h4 class="text-sm font-bold text-slate-700 dark:text-slate-300 mb-3">Links</h4>
        
        <div class="space-y-3">
          <div>
            <label class="block text-xs font-bold uppercase text-slate-500 mb-1">External / Main Link</label>
            <input type="url" name="socialLink" placeholder="https://" class="w-full p-2 border rounded dark:bg-slate-800 dark:border-slate-700" />
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
            <div>
              <label class="block text-xs font-bold uppercase text-slate-500 mb-1">X (Twitter)</label>
              <input type="text" name="xLink" placeholder="https://x.com/..." class="w-full p-2 border rounded dark:bg-slate-800 dark:border-slate-700" />
            </div>
            <div>
              <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Discord</label>
              <input type="text" name="discordLink" placeholder="https://discord.gg/..." class="w-full p-2 border rounded dark:bg-slate-800 dark:border-slate-700" />
            </div>
            <div>
              <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Telegram</label>
              <input type="text" name="telegramLink" placeholder="https://t.me/..." class="w-full p-2 border rounded dark:bg-slate-800 dark:border-slate-700" />
            </div>
          </div>
        </div>
      </div>

      <div>
        <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Tags (comma separated)</label>
        <input type="text" name="tags" placeholder="tech, ai, crypto" class="w-full p-2 border rounded dark:bg-slate-800 dark:border-slate-700" />
      </div>

      <div class="flex items-center gap-2">
        <input type="checkbox" name="published" id="pub-check" class="w-5 h-5" />
        <label for="pub-check">Published (Visible to public)</label>
      </div>

      <div class="pt-4 flex gap-3">
        <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700">Save Post</button>
        <button type="button" id="delete-btn" class="hidden px-4 py-2 bg-red-100 text-red-600 rounded hover:bg-red-200">Delete</button>
      </div>
    </form>
  </div>
</div>
</div>
<!-- Admin DEAL Editor Modal -->
<div id="deal-editor-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
<div class="bg-white dark:bg-slate-900 w-full max-w-3xl max-h-[95vh] rounded-2xl shadow-2xl overflow-hidden flex flex-col relative animate-fade-in">
<div class="p-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-800">
<h3 class="font-bold text-lg text-amber-600">Create/Edit Insider Deal</h3>
<button onclick="app.closeModals()" class="text-slate-500 hover:text-red-500"><i class="fa-solid fa-xmark text-xl"></i></button>
</div>
<div class="overflow-y-auto p-6 flex-1">
<form id="deal-form" class="space-y-4">
<input type="hidden" name="id" />
code
Code
<div>
                <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Deal Title</label>
                <input type="text" name="title" required class="w-full p-2 border rounded dark:bg-slate-800 dark:border-slate-700" />
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="flex items-center gap-2 pt-4">
                    <input type="checkbox" name="isFreeOffer" id="deal-free-check" class="w-5 h-5 accent-green-600" />
                    <label for="deal-free-check" class="font-medium">Free for limited time?</label>
                </div>
                <div>
                    <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Expires At (Optional)</label>
                    <input type="datetime-local" name="expiresAt" class="w-full p-2 border rounded dark:bg-slate-800 dark:border-slate-700" />
                </div>
            </div>

            <div>
                <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Full Description (Premium Tips)</label>
                <textarea name="description" rows="6" class="w-full p-2 border rounded dark:bg-slate-800 dark:border-slate-700 font-mono text-sm"></textarea>
            </div>

            <!-- Multiple Images -->
            <div>
                <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Images (Multiple)</label>
                <input type="file" id="deal-img-upload" accept="image/*" multiple class="w-full text-sm mb-2" />
                <div id="deal-img-list" class="flex flex-wrap gap-2"></div>
                <!-- Hidden field to store array of URLs -->
                <input type="hidden" name="imagesJSON" value="[]" />
            </div>

            <!-- Dynamic Links -->
            <div class="border-t border-slate-200 dark:border-slate-700 pt-4">
                <div class="flex justify-between items-center mb-2">
                    <label class="block text-xs font-bold uppercase text-slate-500">Links</label>
                    <button type="button" onclick="app.addDealLinkField()" class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded hover:bg-blue-200">+ Add Link</button>
                </div>
                <div id="deal-links-editor" class="space-y-2"></div>
            </div>

            <div class="flex items-center gap-2 pt-2 border-t border-slate-200 dark:border-slate-700">
                <input type="checkbox" name="published" id="deal-pub-check" class="w-5 h-5 accent-blue-600" />
                <label for="deal-pub-check">Published (Visible to Insiders)</label>
            </div>

            <div class="pt-4 flex gap-3">
                <button type="submit" class="flex-1 bg-amber-600 text-white py-2 rounded hover:bg-amber-700 font-bold">Save Deal</button>
                <button type="button" id="deal-delete-btn" class="hidden px-4 py-2 bg-red-100 text-red-600 rounded hover:bg-red-200">Delete</button>
            </div>
        </form>
    </div>
</div>
</div>
<!-- JS LOGIC -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
import {
getFirestore, collection, doc, setDoc, addDoc, updateDoc, deleteDoc,
onSnapshot, query, orderBy, serverTimestamp, where, limit, Timestamp
} from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

// 1) Firebase
const firebaseConfig = {
apiKey: "AIzaSyCrlPPqqPjMJTvMWnDxlrQ9F1i8QCWXh44",
authDomain: "x-pro-libraryb.firebaseapp.com",
projectId: "x-pro-libraryb",
storageBucket: "x-pro-libraryb.firebasestorage.app",
messagingSenderId: "550613022642",
appId: "1:550613022642:web:77468592649f680db796ab",
};

// 2) ImageKit
const IK_PUBLIC_KEY = "public_yRB2dktvG7CXL9J/UNiO8v7Aolg=";
const IK_URL_ENDPOINT = "https://ik.imagekit.io/cgdkn8ki9";
const IK_AUTH_ENDPOINT = "/api/imagekit-auth";

const imagekit = new window.ImageKit({
publicKey: IK_PUBLIC_KEY,
urlEndpoint: IK_URL_ENDPOINT,
});

// Firebase init
const fbApp = initializeApp(firebaseConfig);
const auth = getAuth(fbApp);
const db = getFirestore(fbApp);

// STATE
const state = {
user: null,
isAdmin: false,
settings: {
siteName: "X Pro Library",
heroTitle: "Discover Excellence",
heroSubtitle: "Curated Alpha Posts & AI Tools for the modern professional.",
primaryTheme: "blue",
allowedAdminEmail: "",
},
posts: [],
insiderDeals: [], // New collection data
filters: { search: "", type: "all", category: "all", xScoreRange: "all" },
categories: new Set(),
initialDeepLinkChecked: false,
insiderAccess: false, // Local gate state
dealCarouselIdx: 0,
currentDealImages: []
};

// DOM Elements Map
const els = {
toast: document.getElementById("toast-container"),
notifContainer: document.getElementById("notification-container"),
grid: document.getElementById("posts-grid"),
empty: document.getElementById("empty-state"),
insiderView: document.getElementById("insider-view"),
insiderGrid: document.getElementById("insider-grid"),
standardView: document.getElementById("standard-view-content"),
modals: {
post: document.getElementById("post-modal"),
auth: document.getElementById("auth-modal"),
editor: document.getElementById("editor-modal"),
deal: document.getElementById("deal-modal"),
dealEditor: document.getElementById("deal-editor-modal"),
gate: document.getElementById("gate-modal"),
},
filters: {
typeBtns: document.querySelectorAll(".filter-type-btn"),
xScoreBtns: document.querySelectorAll(".filter-xscore-btn"),
xScoreRow: document.getElementById("xscore-filter-row"),
category: document.getElementById("category-filter"),
searchGlobal: document.getElementById("global-search"),
searchMobile: document.getElementById("mobile-search"),
},
admin: {
btn: document.getElementById("admin-panel-btn"),
view: document.getElementById("admin-view"),
publicView: document.getElementById("public-view"),
postsBody: document.getElementById("admin-posts-table-body"),
dealsBody: document.getElementById("admin-deals-table-body"),
tabs: {
posts: document.getElementById("admin-posts-tab"),
deals: document.getElementById("admin-deals-tab"),
settings: document.getElementById("admin-settings-tab"),
notifications: document.getElementById("admin-notifications-tab"),
},
buttons: {
posts: document.getElementById("tab-btn-posts"),
deals: document.getElementById("tab-btn-deals"),
settings: document.getElementById("tab-btn-settings"),
notifications: document.getElementById("tab-btn-notifications"),
}
},
catList: document.getElementById("cat-list"),
editor: {
typeSelect: document.getElementById("editor-type-select"),
stdScore: document.getElementById("field-std-score"),
xScore: document.getElementById("field-xscore"),
},
dealEditor: {
linksContainer: document.getElementById("deal-links-editor"),
imgList: document.getElementById("deal-img-list"),
}
};

// Helpers
const showToast = (msg, type = "info") => {
const el = document.createElement("div");
const colors = type === "error" ? "bg-red-500" : "bg-slate-800 dark:bg-slate-700";
el.className = `${colors} pointer-events-auto text-white px-4 py-3 rounded shadow-lg transform transition-all translate-y-2 opacity-0 text-sm font-medium`;
el.innerText = msg;
els.toast.appendChild(el);
setTimeout(() => el.classList.remove("translate-y-2", "opacity-0"), 10);
setTimeout(() => {
el.classList.add("opacity-0");
setTimeout(() => el.remove(), 300);
}, 3000);
};

const debounce = (func, wait) => {
let timeout;
return function (...args) {
clearTimeout(timeout);
timeout = setTimeout(() => func.apply(this, args), wait);
};
};

window.app = {
init: async () => {
if (
localStorage.getItem("theme") === "dark" ||
(!("theme" in localStorage) && window.matchMedia("(prefers-color-scheme: dark)").matches)
) {
document.documentElement.classList.add("dark");
}

// Check local storage for Insider Access
if (localStorage.getItem("insider_access") === "true") {
state.insiderAccess = true;
}

app.listenSettings();
app.listenPosts();
app.listenInsiderDeals(); // Listen to deals
app.listenNotifications();

document.getElementById("theme-toggle").onclick = app.toggleTheme;
document.getElementById("auth-btn").onclick = () => app.openModal("auth");
document.getElementById("admin-panel-btn").onclick = app.openAdmin;
document.getElementById("auth-form").onsubmit = app.handleAuth;
document.getElementById("post-form").onsubmit = app.savePost;
document.getElementById("deal-form").onsubmit = app.saveDeal;
document.getElementById("delete-btn").onclick = app.deletePost;
document.getElementById("deal-delete-btn").onclick = app.deleteDeal;
document.getElementById("img-upload").onchange = app.handleImagePreview;
document.getElementById("deal-img-upload").onchange = app.handleDealImagesUpload;
document.getElementById("notification-form").onsubmit = app.sendNotification;

els.editor.typeSelect.onchange = app.handleEditorTypeChange;
els.filters.searchGlobal.oninput = debounce((e) => app.setFilter("search", e.target.value), 300);
els.filters.searchMobile.oninput = debounce((e) => app.setFilter("search", e.target.value), 300);

onAuthStateChanged(auth, (user) => {
state.user = user;
app.checkAdminAccess();
app.updateAuthUI();
});
},

toggleTheme: () => {
const isDark = document.documentElement.classList.toggle("dark");
localStorage.setItem("theme", isDark ? "dark" : "light");
},

handleAuth: async (e) => {
e.preventDefault();
const email = document.getElementById("auth-email").value;
const pass = document.getElementById("auth-pass").value;
try {
await signInWithEmailAndPassword(auth, email, pass);
showToast("Welcome back!");
} catch (err) {
try {
await createUserWithEmailAndPassword(auth, email, pass);
showToast("Account created!");
} catch (regErr) {
showToast(regErr.message, "error");
}
}
app.closeModals();
},

logout: () => {
signOut(auth);
app.closeModals();
showToast("Logged out");
window.location.reload();
},

updateAuthUI: () => {
const btn = document.getElementById("auth-btn");
const modalInfo = document.getElementById("auth-user-info");
const modalForm = document.getElementById("auth-form");
if (state.user) {
btn.innerText = "Account";
modalForm.classList.add("hidden");
modalInfo.classList.remove("hidden");
document.getElementById("user-email-display").innerText = state.user.email;
} else {
btn.innerText = "Sign In";
modalForm.classList.remove("hidden");
modalInfo.classList.add("hidden");
}
},

checkAdminAccess: () => {
if (state.user && state.settings.allowedAdminEmail && state.user.email === state.settings.allowedAdminEmail) {
state.isAdmin = true;
els.admin.btn.classList.remove("hidden");
} else {
state.isAdmin = false;
els.admin.btn.classList.add("hidden");
if (!els.admin.view.classList.contains("hidden")) app.closeAdmin();
}
},

// --- INSIDER DEALS LOGIC ---

requestInsiderAccess: () => {
if (state.insiderAccess) {
app.switchPublicView('insider');
} else {
app.openModal('gate');
}
},

verifyInsiderCode: (e) => {
e.preventDefault();
const codeInput = document.getElementById("gate-code");
if (codeInput.value === "CryptoAIInsider") {
state.insiderAccess = true;
localStorage.setItem("insider_access", "true");
showToast("Access Granted. Welcome Insider.", "success");
app.closeModals();
app.switchPublicView('insider');
codeInput.value = "";
} else {
showToast("Invalid Access Code.", "error");
codeInput.classList.add("ring-2", "ring-red-500");
setTimeout(() => codeInput.classList.remove("ring-2", "ring-red-500"), 500);
}
},

lockInsider: () => {
state.insiderAccess = false;
localStorage.removeItem("insider_access");
showToast("Access Locked.");
app.switchPublicView('home');
},

switchPublicView: (view) => {
if (view === 'insider') {
els.standardView.classList.add("hidden");
els.insiderView.classList.remove("hidden");
window.scrollTo(0,0);
app.renderInsiderGrid();
} else {
els.insiderView.classList.add("hidden");
els.standardView.classList.remove("hidden");
window.scrollTo(0,0);
}
},

listenInsiderDeals: () => {
// Listen to new collection
let q = query(collection(db, "insiderDeals"), orderBy("createdAt", "desc"));

onSnapshot(q, (snapshot) => {
state.insiderDeals = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));

if (!els.insiderView.classList.contains("hidden")) {
app.renderInsiderGrid();
}
if (state.isAdmin) app.renderAdminDealsTable();

// Check deep link for DEALS (different param)
const params = new URLSearchParams(window.location.search);
const dealId = params.get('deal');
if (dealId && !state.initialDeepLinkChecked) {
if(state.insiderAccess) {
app.openDealDetails(dealId, true);
} else {
app.openModal('gate'); // Gate it
}
state.initialDeepLinkChecked = true;
}
});
},

renderInsiderGrid: () => {
els.insiderGrid.innerHTML = "";
const activeDeals = state.insiderDeals.filter(d => state.isAdmin || d.published);

if (activeDeals.length === 0) {
document.getElementById("insider-empty").classList.remove("hidden");
return;
}
document.getElementById("insider-empty").classList.add("hidden");

activeDeals.forEach(d => {
const coverImg = (d.images && d.images.length > 0) ? d.images[0] : "https://via.placeholder.com/400x300?text=Secret+Deal";
const isFree = d.isFreeOffer;

// Check Expiry
let isExpired = false;
if (d.expiresAt) {
const expDate = d.expiresAt.toDate();
if (new Date() > expDate) isExpired = true;
}

const el = document.createElement("div");
el.className = `group bg-white dark:bg-slate-800 rounded-2xl overflow-hidden shadow-lg border border-slate-100 dark:border-slate-700 flex flex-col hover:shadow-2xl transition duration-300 ${isExpired ? 'opacity-60 grayscale' : ''}`;

el.innerHTML = `
<div class="relative h-56 overflow-hidden cursor-pointer" onclick="app.openDealDetails('${d.id}')">
<img src="${coverImg}" class="w-full h-full object-cover group-hover:scale-105 transition duration-700">
<div class="absolute top-3 left-3 flex gap-2">
${isFree ? '<span class="px-3 py-1 bg-green-500 text-white text-xs font-bold uppercase rounded-full shadow-lg">Free</span>' : ''}
${isExpired ? '<span class="px-3 py-1 bg-red-600 text-white text-xs font-bold uppercase rounded-full shadow-lg">Expired</span>' : '<span class="px-3 py-1 bg-amber-500 text-white text-xs font-bold uppercase rounded-full shadow-lg">Insider</span>'}
</div>
</div>
<div class="p-6 flex flex-col flex-1">
<h3 class="text-xl font-bold mb-2 group-hover:text-amber-600 transition">${d.title}</h3>
<p class="text-slate-500 text-sm line-clamp-3 mb-6 flex-1">${d.description || ""}</p>
<button onclick="app.openDealDetails('${d.id}')" class="w-full py-3 bg-slate-100 dark:bg-slate-700 hover:bg-amber-500 hover:text-white dark:hover:bg-amber-600 transition rounded-xl font-semibold">
${isExpired ? 'View Archived Deal' : 'Unlock Deal'}
</button>
</div>
`;
els.insiderGrid.appendChild(el);
});
},

openDealDetails: (id, skipPush = false) => {
const d = state.insiderDeals.find(x => x.id === id);
if (!d) return;

if (!skipPush) {
const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?deal=' + id;
window.history.pushState({ path: newUrl }, '', newUrl);
}

// Setup Modal
const m = els.modals.deal;
m.querySelector("#deal-title").innerText = d.title;
m.querySelector("#deal-desc").innerText = d.description;

// Badges
const badgeFree = m.querySelector("#deal-badge-free");
const badgeExp = m.querySelector("#deal-badge-expiry");

if(d.isFreeOffer) badgeFree.classList.remove("hidden");
else badgeFree.classList.add("hidden");

if(d.expiresAt && new Date() > d.expiresAt.toDate()) {
badgeExp.innerText = "Expired";
badgeExp.className = "bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide";
badgeExp.classList.remove("hidden");
} else if (d.expiresAt) {
const days = Math.ceil((d.expiresAt.toDate() - new Date()) / (1000 * 60 * 60 * 24));
badgeExp.innerText = `${days} Days Left`;
badgeExp.className = "bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide";
badgeExp.classList.remove("hidden");
} else {
badgeExp.classList.add("hidden");
}

// Links
const linksCont = document.getElementById("deal-links-container");
linksCont.innerHTML = "";
if(d.links && Array.isArray(d.links)) {
d.links.forEach(l => {
const btn = document.createElement("a");
btn.href = l.url;
btn.target = "_blank";
btn.className = "block w-full text-center py-3 rounded-lg bg-amber-600 text-white font-bold hover:bg-amber-700 transition shadow-md";
btn.innerHTML = `${l.label} <i class="fa-solid fa-arrow-up-right-from-square ml-2"></i>`;
linksCont.appendChild(btn);
});
}

// Carousel
state.currentDealImages = (d.images && d.images.length) ? d.images : ["https://via.placeholder.com/800x600?text=No+Image"];
state.dealCarouselIdx = 0;
app.updateDealCarousel();

app.openModal("deal");
},

updateDealCarousel: () => {
const track = document.getElementById("deal-carousel-track");
const dots = document.getElementById("deal-carousel-dots");

track.innerHTML = "";
dots.innerHTML = "";

state.currentDealImages.forEach((src, idx) => {
const img = document.createElement("img");
img.src = src;
img.className = "min-w-full h-full object-cover";
track.appendChild(img);

const dot = document.createElement("div");
dot.className = `w-2 h-2 rounded-full transition ${idx === state.dealCarouselIdx ? 'bg-white scale-125' : 'bg-white/50'}`;
dots.appendChild(dot);
});

track.style.transform = `translateX(-${state.dealCarouselIdx * 100}%)`;
},

cycleDealImage: (dir) => {
const len = state.currentDealImages.length;
if (len <= 1) return;
state.dealCarouselIdx = (state.dealCarouselIdx + dir + len) % len;
app.updateDealCarousel();
},

// --- ADMIN FOR DEALS ---

openDealEditor: (id = null) => {
const form = document.getElementById("deal-form");
form.reset();
document.getElementById("deal-img-list").innerHTML = "";
document.getElementById("deal-links-editor").innerHTML = "";
form.imagesJSON.value = "[]";
form.id.value = "";
document.getElementById("deal-delete-btn").classList.add("hidden");

if (id) {
const d = state.insiderDeals.find(x => x.id === id);
if (d) {
form.id.value = d.id;
form.title.value = d.title;
form.description.value = d.description;
form.isFreeOffer.checked = d.isFreeOffer;
form.published.checked = d.published;
if (d.expiresAt) {
// Format date for datetime-local
const date = d.expiresAt.toDate();
date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
form.expiresAt.value = date.toISOString().slice(0, 16);
}

// Restore Images
const imgs = d.images || [];
form.imagesJSON.value = JSON.stringify(imgs);
app.renderDealImagesList(imgs);

// Restore Links
if (d.links) {
d.links.forEach(l => app.addDealLinkField(l.label, l.url));
}
document.getElementById("deal-delete-btn").classList.remove("hidden");
}
} else {
// Add one empty link field by default
app.addDealLinkField();
}

app.openModal("dealEditor");
},

addDealLinkField: (label = "", url = "") => {
const c = document.getElementById("deal-links-editor");
const div = document.createElement("div");
div.className = "flex gap-2 items-center deal-link-row";
div.innerHTML = `
<input type="text" placeholder="Label (e.g. Get Offer)" value="${label}" class="link-label flex-1 p-2 border rounded text-xs dark:bg-slate-800 dark:border-slate-700">
<input type="text" placeholder="URL" value="${url}" class="link-url flex-[2] p-2 border rounded text-xs dark:bg-slate-800 dark:border-slate-700">
<button type="button" onclick="this.parentElement.remove()" class="text-red-500 px-2"><i class="fa-solid fa-trash"></i></button>
`;
c.appendChild(div);
},

handleDealImagesUpload: async (e) => {
const files = Array.from(e.target.files);
if (!files.length) return;

showToast(`Uploading ${files.length} images...`);

try {
// 1. Get Auth
const authRes = await fetch(IK_AUTH_ENDPOINT, { cache: "no-store" });
if (!authRes.ok) throw new Error("Auth failed");
const authData = await authRes.json();

const uploadPromises = files.map(file => {
return new Promise((resolve, reject) => {
imagekit.upload({
file,
fileName: "deal_" + Date.now(),
tags: ["insider-deal"],
token: authData.token,
signature: authData.signature,
expire: authData.expire,
}, (err, res) => err ? reject(err) : resolve(res.url));
});
});

const newUrls = await Promise.all(uploadPromises);

const hiddenInput = document.querySelector('input[name="imagesJSON"]');
const currentUrls = JSON.parse(hiddenInput.value || "[]");
const updatedUrls = [...currentUrls, ...newUrls];

hiddenInput.value = JSON.stringify(updatedUrls);
app.renderDealImagesList(updatedUrls);

showToast("Images uploaded successfully!");
e.target.value = ""; // clear input
} catch (err) {
console.error(err);
showToast("Upload failed", "error");
}
},

renderDealImagesList: (urls) => {
const c = document.getElementById("deal-img-list");
c.innerHTML = "";
urls.forEach((url, idx) => {
const div = document.createElement("div");
div.className = "relative w-16 h-16 rounded overflow-hidden border border-slate-300";
div.innerHTML = `
<img src="${url}" class="w-full h-full object-cover">
<button type="button" class="absolute top-0 right-0 bg-red-500 text-white w-4 h-4 flex items-center justify-center text-xs"
onclick="app.removeDealImage(${idx})">&times;</button>
`;
c.appendChild(div);
});
},

removeDealImage: (idx) => {
const hiddenInput = document.querySelector('input[name="imagesJSON"]');
const urls = JSON.parse(hiddenInput.value);
urls.splice(idx, 1);
hiddenInput.value = JSON.stringify(urls);
app.renderDealImagesList(urls);
},

saveDeal: async (e) => {
e.preventDefault();
const f = e.target;

// Harvest Links
const linkRows = document.querySelectorAll(".deal-link-row");
const links = [];
linkRows.forEach(row => {
const label = row.querySelector(".link-label").value.trim();
const url = row.querySelector(".link-url").value.trim();
if(label && url) links.push({ label, url });
});

const data = {
title: f.title.value,
description: f.description.value,
isFreeOffer: f.isFreeOffer.checked,
published: f.published.checked,
images: JSON.parse(f.imagesJSON.value),
links: links,
updatedAt: serverTimestamp()
};

if (f.expiresAt.value) {
data.expiresAt = Timestamp.fromDate(new Date(f.expiresAt.value));
} else {
data.expiresAt = null;
}

try {
if (f.id.value) {
await updateDoc(doc(db, "insiderDeals", f.id.value), data);
showToast("Deal Updated");
} else {
data.createdAt = serverTimestamp();
await addDoc(collection(db, "insiderDeals"), data);
showToast("Deal Created");
}
app.closeModals();
} catch(err) {
showToast(err.message, "error");
}
},

deleteDeal: async () => {
const id = document.querySelector('#deal-form input[name="id"]').value;
if (!id || !confirm("Delete this deal?")) return;
try {
await deleteDoc(doc(db, "insiderDeals", id));
showToast("Deal deleted");
app.closeModals();
} catch(err) {
showToast(err.message, "error");
}
},

renderAdminDealsTable: () => {
const tbody = els.admin.dealsBody;
tbody.innerHTML = "";
state.insiderDeals.forEach(d => {
const tr = document.createElement("tr");
tr.className = "hover:bg-slate-50 dark:hover:bg-slate-700 border-b border-slate-100 dark:border-slate-700";

let status = d.published ? '<span class="text-green-500">Live</span>' : '<span class="text-slate-400">Draft</span>';
let expiry = "-";
if (d.expiresAt) {
const date = d.expiresAt.toDate();
expiry = date.toLocaleDateString();
if (date < new Date()) expiry += " (Exp)";
}

tr.innerHTML = `
<td class="p-4 font-bold dark:text-white">${d.title}</td>
<td class="p-4 text-xs uppercase font-bold">${status}</td>
<td class="p-4 text-sm">${expiry}</td>
<td class="p-4 text-right">
<button class="text-amber-600 hover:underline" onclick="app.openDealEditor('${d.id}')">Edit</button>
</td>
`;
tbody.appendChild(tr);
});
},

listenSettings: () => {
onSnapshot(doc(db, "settings", "app"), (docSnap) => {
if (docSnap.exists()) {
state.settings = { ...state.settings, ...docSnap.data() };
app.applySettings();
app.checkAdminAccess();
}
});
},

applySettings: () => {
document.getElementById("nav-logo").innerText = state.settings.siteName || "X Pro";
document.getElementById("hero-title").innerText = state.settings.heroTitle || "Discover Excellence";
document.getElementById("hero-subtitle").innerText =
state.settings.heroSubtitle || "Curated Alpha Posts & AI Tools for the modern professional.";

const logo = document.getElementById("nav-logo");
const theme = state.settings.primaryTheme || "blue";
logo.className = `text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-${theme}-600 to-purple-600`;

const f = document.getElementById("settings-form");
f.siteName.value = state.settings.siteName || "";
f.heroTitle.value = state.settings.heroTitle || "";
f.heroSubtitle.value = state.settings.heroSubtitle || "";
f.primaryTheme.value = state.settings.primaryTheme || "blue";
f.allowedAdminEmail.value = state.settings.allowedAdminEmail || "";

f.onsubmit = async (e) => {
e.preventDefault();
if (!state.isAdmin) return;
const data = Object.fromEntries(new FormData(f));
await setDoc(doc(db, "settings", "app"), data, { merge: true });
showToast("Settings saved");
};
},

listenPosts: () => {
let q;
if (state.isAdmin) {
q = query(collection(db, "posts"));
} else {
q = query(
collection(db, "posts"),
where("published", "==", true)
);
}

onSnapshot(
q,
(snapshot) => {
state.posts = snapshot.docs
.map(d => ({ id: d.id, ...d.data() }))
.sort((a, b) => {
const ta = a.createdAt?.seconds || 0;
const tb = b.createdAt?.seconds || 0;
return tb - ta;
});

app.extractCategories();
app.renderGrid();
if (state.isAdmin) app.renderAdminTable();

// Check for Post Deep Link
if (!state.initialDeepLinkChecked) {
const params = new URLSearchParams(window.location.search);
const linkedPostId = params.get('post');
if (linkedPostId) {
const postExists = state.posts.find(p => p.id === linkedPostId);
if (postExists) {
app.openPostDetails(linkedPostId, true);
}
}
// Note: We don't set initialDeepLinkChecked to true here because we might need to check deal link too
}
},
(err) => {
console.error("Posts listener error:", err);
showToast("Failed to load posts", "error");
}
);
},

extractCategories: () => {
state.categories = new Set(state.posts.map((p) => p.category).filter(Boolean));
els.filters.category.innerHTML = '<option value="all">All Categories</option>';
state.categories.forEach((c) => {
els.filters.category.innerHTML += `<option value="${c}">${c}</option>`;
});
els.catList.innerHTML = [...state.categories].map((c) => `<option value="${c}"></option>`).join("");
},

setFilter: (key, val) => {
state.filters[key] = val;

if (key === "type") {
els.filters.typeBtns.forEach((b) => {
const active = b.dataset.val === val;
b.classList.toggle("bg-white", active);
b.classList.toggle("shadow-sm", active);
b.classList.toggle("text-blue-600", active);
});

if (val === 'xscore') {
els.filters.xScoreRow.classList.remove("hidden");
} else {
els.filters.xScoreRow.classList.add("hidden");
}
}

if (key === "xScoreRange") {
els.filters.xScoreBtns.forEach((b) => {
const active = b.dataset.val === val;
b.classList.toggle("bg-slate-800", active);
b.classList.toggle("text-white", active);
b.classList.toggle("border-transparent", active);
});
}

app.renderGrid();
},

filterPosts: () => {
return state.posts.filter((p) => {
if (!p.published && !state.isAdmin) return false;

const tagsText = Array.isArray(p.tags) ? p.tags.join(" ") : (p.tags || "");
const title = (p.title || "");
const desc = (p.description || "");

if (state.filters.search) {
const term = state.filters.search.toLowerCase();
const match = (title + " " + desc + " " + tagsText).toLowerCase();
if (!match.includes(term)) return false;
}

if (state.filters.type !== "all" && p.type !== state.filters.type) return false;
if (state.filters.category !== "all" && p.category !== state.filters.category) return false;

if (state.filters.type === "xscore" && state.filters.xScoreRange !== "all") {
const xVal = Number(p.xScore || 0);
const [min, max] = state.filters.xScoreRange.split("-").map(Number);
if (xVal < min || xVal > max) return false;
}

return true;
});
},

renderGrid: () => {
const filtered = app.filterPosts();
els.grid.innerHTML = "";

if (filtered.length === 0) {
els.empty.classList.remove("hidden");
return;
}
els.empty.classList.add("hidden");

filtered.forEach((p) => {
const card = document.createElement("div");
card.className =
"bg-white dark:bg-slate-900 rounded-xl overflow-hidden shadow-sm hover:shadow-xl transition duration-300 border border-slate-100 dark:border-slate-800 group flex flex-col h-full";

let badgeColor = "bg-gray-100 text-gray-700";
if (p.type === "alpha") badgeColor = "bg-purple-100 text-purple-700";
else if (p.type === "tool") badgeColor = "bg-blue-100 text-blue-700";
else if (p.type === "xscore") badgeColor = "bg-indigo-100 text-indigo-700";

let scoreBadgeHTML = "";
if (p.type === "xscore") {
const xVal = Number(p.xScore || 0);
const sColor = xVal >= 800 ? "bg-green-100 text-green-700" : xVal >= 400 ? "bg-blue-100 text-blue-700" : "bg-orange-100 text-orange-700";
scoreBadgeHTML = `<span class="px-2 py-1 rounded-md text-xs font-bold ${sColor}">${xVal}</span>`;
}

// Small Social Icons for Card
let socialIcons = "";
if (p.xLink) socialIcons += `<a href="${p.xLink}" target="_blank" class="text-slate-400 hover:text-black dark:hover:text-white" title="X (Twitter)"><i class="fa-brands fa-x-twitter"></i></a>`;
if (p.discordLink) socialIcons += `<a href="${p.discordLink}" target="_blank" class="text-slate-400 hover:text-indigo-500" title="Discord"><i class="fa-brands fa-discord"></i></a>`;
if (p.telegramLink) socialIcons += `<a href="${p.telegramLink}" target="_blank" class="text-slate-400 hover:text-sky-500" title="Telegram"><i class="fa-brands fa-telegram"></i></a>`;

if(socialIcons) socialIcons = `<div class="flex gap-3 ml-2 border-l border-slate-200 dark:border-slate-700 pl-3">${socialIcons}</div>`;

const img = p.imageUrl || "https://via.placeholder.com/400x300?text=No+Image";
const tags = Array.isArray(p.tags) ? p.tags : [];

card.innerHTML = `
<div class="relative h-48 overflow-hidden cursor-pointer" onclick="app.openPostDetails('${p.id}')">
<img src="${img}" class="w-full h-full object-cover group-hover:scale-105 transition duration-500">
<div class="absolute top-2 left-2 flex gap-1">
<span class="px-2 py-1 rounded-md text-xs font-bold uppercase ${badgeColor}">${p.type || "Post"}</span>
</div>
<div class="absolute top-2 right-2">
${scoreBadgeHTML}
</div>
</div>
<div class="p-5 flex flex-col flex-1">
<div class="flex justify-between items-start mb-2">
<span class="text-xs text-slate-400 font-semibold uppercase tracking-wider">${p.category || ""}</span>
</div>
<h3 class="text-xl font-bold mb-2 group-hover:text-blue-600 transition cursor-pointer" onclick="app.openPostDetails('${p.id}')">${p.title || ""}</h3>
<p class="text-slate-500 text-sm line-clamp-3 mb-4 flex-1">${p.description || ""}</p>
<div class="pt-4 border-t border-slate-100 dark:border-slate-800 flex items-center justify-between">
<div class="flex items-center flex-1 overflow-hidden">
<div class="flex gap-2 overflow-hidden text-ellipsis whitespace-nowrap">
${tags.slice(0, 2).map((t) => `<span class="text-xs bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded text-slate-500">#${t}</span>`).join("")}
</div>
${socialIcons}
</div>
<button onclick="app.openPostDetails('${p.id}')" class="text-blue-600 hover:text-blue-700 text-sm font-semibold ml-2 whitespace-nowrap">View <i class="fa-solid fa-arrow-right ml-1"></i></button>
</div>
</div>
`;
els.grid.appendChild(card);
});
},

openModal: (id) => {
document.querySelectorAll('[id$="-modal"]').forEach((m) => m.classList.add("hidden"));
els.modals[id].classList.remove("hidden");
},

closeModals: () => {
// If post/deal modal is open, we need to clear query string
if (!els.modals.post.classList.contains("hidden") || !els.modals.deal.classList.contains("hidden")) {
const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
window.history.pushState({ path: newUrl }, '', newUrl);
}
document.querySelectorAll('[id$="-modal"]').forEach((m) => m.classList.add("hidden"));
},

openPostDetails: (id, skipPushState = false) => {
const p = state.posts.find((x) => x.id === id);
if (!p) return;

if (!skipPushState) {
const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?post=' + id;
window.history.pushState({ path: newUrl }, '', newUrl);
}

const m = els.modals.post;
m.querySelector("#modal-img").src = p.imageUrl || "";
m.querySelector("#modal-title").innerText = p.title || "";
m.querySelector("#modal-desc").innerText = p.description || "";
m.querySelector("#modal-content").innerText = p.content || "";
m.querySelector("#modal-type").innerText = p.type || "Post";

const scoreContainer = m.querySelector("#modal-score-container");
if (p.type === "xscore") {
scoreContainer.classList.remove("hidden");
scoreContainer.innerText = `XS: ${Number(p.xScore || 0)}`;
scoreContainer.className = "px-2 py-0.5 rounded text-xs font-bold bg-indigo-500 text-white";
} else {
scoreContainer.classList.add("hidden");
}

const tags = Array.isArray(p.tags) ? p.tags : [];
m.querySelector("#modal-tags").innerHTML = tags
.map((t) => `<span class="bg-slate-200 dark:bg-slate-700 px-2 py-1 rounded text-xs font-bold text-slate-600 dark:text-slate-300">#${t}</span>`)
.join("");

// Social Buttons Logic (X, Discord, Telegram)
const socialRow = m.querySelector("#modal-social-row");
socialRow.innerHTML = "";

const createSocialBtn = (link, iconClass, label, colorClass) => {
return `
<a href="${link}" target="_blank" class="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-semibold transition shadow-sm ${colorClass}">
<i class="${iconClass}"></i> ${label}
</a>
`;
};

if (p.xLink) {
socialRow.innerHTML += createSocialBtn(p.xLink, "fa-brands fa-x-twitter", "X", "bg-black text-white hover:bg-slate-800 dark:bg-white dark:text-black dark:hover:bg-slate-200");
}
if (p.discordLink) {
socialRow.innerHTML += createSocialBtn(p.discordLink, "fa-brands fa-discord", "Discord", "bg-[#5865F2] text-white hover:opacity-90");
}
if (p.telegramLink) {
socialRow.innerHTML += createSocialBtn(p.telegramLink, "fa-brands fa-telegram", "Telegram", "bg-[#0088cc] text-white hover:opacity-90");
}

// External Link Button (Original)
const linkBtn = m.querySelector("#modal-link");
if (p.socialLink) {
linkBtn.href = p.socialLink;
linkBtn.classList.remove("hidden");
} else {
linkBtn.classList.add("hidden");
}

app.currentShareLink = window.location.origin + "/?post=" + p.id;
app.openModal("post");
},

sharePost: () => {
navigator.clipboard.writeText(app.currentShareLink || window.location.href);
showToast("Deep Link copied to clipboard!");
},

openAdmin: () => {
els.admin.view.classList.remove("hidden");
els.admin.publicView.classList.add("hidden");
window.scrollTo(0, 0);
app.renderAdminTable();
app.renderAdminDealsTable(); // Render deals tab too
app.populateNotifDropdown();
},

closeAdmin: () => {
els.admin.view.classList.add("hidden");
els.admin.publicView.classList.remove("hidden");
},

switchAdminTab: (tab) => {
Object.values(els.admin.tabs).forEach(el => el.classList.add("hidden"));
els.admin.tabs[tab].classList.remove("hidden");

Object.values(els.admin.buttons).forEach(btn => {
btn.classList.remove("border-blue-600");
btn.classList.add("border-transparent");
btn.classList.add("text-slate-500");
});
const activeBtn = els.admin.buttons[tab];
if(activeBtn) {
activeBtn.classList.remove("border-transparent", "text-slate-500");
activeBtn.classList.add("border-blue-600");
}
},

renderAdminTable: () => {
const tbody = els.admin.postsBody;
tbody.innerHTML = "";
state.posts.forEach((p) => {
const tr = document.createElement("tr");
tr.className = "hover:bg-slate-50 dark:hover:bg-slate-700 border-b border-slate-100 dark:border-slate-700";

let scoreDisplay = "-";
if (p.type === 'xscore') scoreDisplay = `XS: ${p.xScore || 0}`;
else if (p.score) scoreDisplay = p.score;

tr.innerHTML = `
<td class="p-4 font-medium dark:text-white">${p.title || ""}</td>
<td class="p-4"><span class="px-2 py-1 rounded text-xs bg-slate-100 dark:bg-slate-600">${p.type || ""}</span></td>
<td class="p-4">${scoreDisplay}</td>
<td class="p-4"><span class="w-2 h-2 inline-block rounded-full ${p.published ? "bg-green-500" : "bg-red-500"}"></span></td>
<td class="p-4 text-right">
<button class="text-blue-600 hover:underline mr-2" onclick="app.openPostModal('${p.id}')">Edit</button>
</td>
`;
tbody.appendChild(tr);
});
},

populateNotifDropdown: () => {
const sel = document.getElementById("notif-post-select");
sel.innerHTML = '<option value="">-- Manual Entry --</option>';
state.posts.forEach(p => {
const opt = document.createElement("option");
opt.value = p.id;
opt.innerText = (p.title || "Untitled").substring(0, 40);
sel.appendChild(opt);
});
},

fillNotificationForm: (postId) => {
const form = document.getElementById("notification-form");
if (!postId) {
form.reset();
return;
}
const p = state.posts.find(x => x.id === postId);
if (p) {
form.title.value = p.title || "";
form.imageUrl.value = p.imageUrl || "";
form.postId.value = p.id;
}
},

sendNotification: async (e) => {
e.preventDefault();
if (!state.isAdmin) return;

const f = e.target;
const data = {
title: f.title.value,
message: f.message.value,
imageUrl: f.imageUrl.value,
postId: f.postId.value,
createdAt: serverTimestamp(),
sentBy: state.user.email
};

try {
await addDoc(collection(db, "notifications"), data);
showToast("Notification Sent!");
f.reset();
} catch (err) {
showToast(err.message, "error");
}
},

listenNotifications: () => {
const q = query(
collection(db, "notifications"),
orderBy("createdAt", "desc"),
limit(5)
);

onSnapshot(q, (snapshot) => {
snapshot.docChanges().forEach((change) => {
if (change.type === "added") {
const notif = change.doc.data();
const id = change.doc.id;

const seen = JSON.parse(localStorage.getItem("seen_notifications") || "[]");

if (!seen.includes(id)) {
app.showNotificationUI(notif, id);
seen.push(id);
localStorage.setItem("seen_notifications", JSON.stringify(seen));
}
}
});
});
},

showNotificationUI: (notif, id) => {
const el = document.createElement("div");
el.className = "pointer-events-auto w-full max-w-sm bg-white dark:bg-slate-800 border-l-4 border-blue-600 rounded-lg shadow-2xl p-4 flex gap-4 animate-slide-in relative overflow-hidden";

const imgHTML = notif.imageUrl
? `<img src="${notif.imageUrl}" class="w-12 h-12 rounded object-cover flex-shrink-0" />`
: `<div class="w-12 h-12 bg-blue-100 dark:bg-slate-700 rounded flex items-center justify-center flex-shrink-0"><i class="fa-solid fa-bell text-blue-600"></i></div>`;

el.innerHTML = `
${imgHTML}
<div class="flex-1">
<h4 class="font-bold text-sm text-slate-800 dark:text-white mb-0.5">${notif.title}</h4>
<p class="text-xs text-slate-500 dark:text-slate-400 mb-2">${notif.message}</p>
${notif.postId ? `<button onclick="app.openPostDetails('${notif.postId}')" class="text-xs bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 transition">View</button>` : ''}
</div>
<button class="absolute top-2 right-2 text-slate-400 hover:text-red-500" onclick="this.parentElement.remove()"><i class="fa-solid fa-xmark"></i></button>
`;

els.notifContainer.appendChild(el);

setTimeout(() => {
if(el && el.parentElement) el.remove();
}, 10000);
},

handleEditorTypeChange: () => {
const type = els.editor.typeSelect.value;
if (type === 'xscore') {
els.editor.stdScore.classList.add("hidden");
els.editor.xScore.classList.remove("hidden");
} else {
els.editor.stdScore.classList.remove("hidden");
els.editor.xScore.classList.add("hidden");
}
},

openPostModal: (id = null) => {
const form = document.getElementById("post-form");
form.reset();
form.id.value = "";
form.imageUrl.value = "";

document.getElementById("img-preview").classList.add("hidden");
document.getElementById("delete-btn").classList.add("hidden");
document.getElementById("editor-title").innerText = "Create New Post";

els.editor.stdScore.classList.remove("hidden");
els.editor.xScore.classList.add("hidden");

if (id) {
const p = state.posts.find((x) => x.id === id);
if (p) {
document.getElementById("editor-title").innerText = "Edit Post";
form.id.value = p.id;
form.type.value = p.type || "alpha";
form.title.value = p.title || "";
form.description.value = p.description || "";
form.content.value = p.content || "";
form.score.value = p.score || "";
form.xScore.value = p.xScore || "";
form.category.value = p.category || "";
form.socialLink.value = p.socialLink || "";

form.xLink.value = p.xLink || "";
form.discordLink.value = p.discordLink || "";
form.telegramLink.value = p.telegramLink || "";

form.tags.value = (Array.isArray(p.tags) ? p.tags : []).join(", ");
form.published.checked = !!p.published;
form.imageUrl.value = p.imageUrl || "";

if (p.imageUrl) {
const prev = document.getElementById("img-preview");
prev.classList.remove("hidden");
prev.style.backgroundImage = `url(${p.imageUrl})`;
}

document.getElementById("delete-btn").classList.remove("hidden");
}
}

app.handleEditorTypeChange();
app.openModal("editor");
},

handleImagePreview: async (e) => {
const file = e.target.files?.[0];
if (!file) return;

if (file.size > 10 * 1024 * 1024) {
showToast("File too large (max 10MB)", "error");
return;
}

showToast("Uploading image...", "info");

try {
const authRes = await fetch(IK_AUTH_ENDPOINT, { cache: "no-store" });
if (!authRes.ok) throw new Error("Auth failed: " + authRes.status);

const authData = await authRes.json();
if (!authData?.token || !authData?.signature || !authData?.expire) {
throw new Error("Auth response missing fields");
}

const result = await new Promise((resolve, reject) => {
imagekit.upload(
{
file,
fileName: "xpro_" + Date.now(),
tags: ["xpro-library"],
token: authData.token,
signature: authData.signature,
expire: authData.expire,
},
(err, res) => (err ? reject(err) : resolve(res))
);
});

document.querySelector('input[name="imageUrl"]').value = result.url;

const prev = document.getElementById("img-preview");
prev.classList.remove("hidden");
prev.style.backgroundImage = `url(${result.url})`;

showToast("Image uploaded!");
} catch (err) {
console.error("Image upload error:", err);
showToast("Image upload failed: " + (err?.message || "unknown"), "error");
}
},

savePost: async (e) => {
e.preventDefault();
const f = e.target;
const id = f.id.value;

// Validation for new social links
const validateLink = (url, name) => {
if (url && !/^https?:\/\//i.test(url)) {
throw new Error(`Invalid URL for ${name}. Must start with http:// or https://`);
}
};

try {
validateLink(f.xLink.value, "X Link");
validateLink(f.discordLink.value, "Discord Link");
validateLink(f.telegramLink.value, "Telegram Link");
validateLink(f.socialLink.value, "External Link");
} catch (err) {
return showToast(err.message, "error");
}

const data = {
type: f.type.value,
title: f.title.value,
description: f.description.value,
content: f.content.value,
score: f.score.value ? Number(f.score.value) : null,
xScore: f.xScore.value ? Number(f.xScore.value) : null,
category: f.category.value,

socialLink: f.socialLink.value,
xLink: f.xLink.value,
discordLink: f.discordLink.value,
telegramLink: f.telegramLink.value,

tags: f.tags.value.split(",").map((t) => t.trim()).filter(Boolean),
published: f.published.checked,
imageUrl: f.imageUrl.value,
updatedAt: serverTimestamp(),
};

try {
if (id) {
await updateDoc(doc(db, "posts", id), data);
showToast("Post updated");
} else {
data.createdAt = serverTimestamp();
await addDoc(collection(db, "posts"), data);
showToast("Post created");
}
app.closeModals();
} catch (err) {
showToast(err.message, "error");
}
},

deletePost: async () => {
const id = document.querySelector('#post-form input[name="id"]').value;
if (!id || !confirm("Are you sure you want to delete this post?")) return;

try {
await deleteDoc(doc(db, "posts", id));
showToast("Post deleted");
app.closeModals();
} catch (err) {
showToast(err.message, "error");
}
},
};

document.addEventListener("keydown", (e) => {
if (e.key === "Escape") app.closeModals();
});

app.init();
</script>
</body>
</html>
