<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X Pro Library</title>
    
    <!-- ImageKit SDK -->
    <script src="https://unpkg.com/imagekit-javascript/dist/imagekit.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    animation: { 'fade-in': 'fadeIn 0.3s ease-out' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
                }
            }
        }
    </script>
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); }
        .dark .glass { background: rgba(15, 23, 42, 0.8); }
        .line-clamp-3 { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-white transition-colors duration-300 font-sans">

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-5 right-5 z-50 flex flex-col gap-2"></div>

    <!-- Navigation -->
    <nav class="fixed w-full z-40 top-0 border-b border-slate-200 dark:border-slate-800 glass">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center cursor-pointer" onclick="window.scrollTo(0,0)">
                    <span class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600" id="nav-logo">X Pro</span>
                </div>
                
                <div class="hidden md:flex flex-1 max-w-lg mx-8 relative">
                    <input type="text" id="global-search" placeholder="Search resources..." class="w-full pl-10 pr-4 py-2 rounded-full bg-slate-100 dark:bg-slate-800 border-none focus:ring-2 focus:ring-blue-500 transition-all">
                    <i class="fa-solid fa-search absolute left-3.5 top-3 text-slate-400"></i>
                </div>

                <div class="flex items-center gap-4">
                    <button id="theme-toggle" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-800 transition">
                        <i class="fa-solid fa-moon"></i>
                    </button>
                    <button id="auth-btn" class="px-4 py-2 rounded-lg font-medium text-sm bg-blue-600 text-white hover:bg-blue-700 transition shadow-lg shadow-blue-500/30">
                        Sign In
                    </button>
                    <!-- Admin Trigger -->
                    <button id="admin-panel-btn" class="hidden px-4 py-2 rounded-lg font-medium text-sm bg-purple-600 text-white hover:bg-purple-700 transition shadow-lg">
                        Admin
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Admin Dashboard (Hidden by default) -->
    <div id="admin-view" class="hidden pt-20 pb-10 min-h-screen bg-slate-100 dark:bg-slate-900">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-slate-800 dark:text-white">Admin Dashboard</h2>
                <div class="flex gap-3">
                    <button onclick="app.closeAdmin()" class="px-4 py-2 bg-slate-200 dark:bg-slate-700 rounded-lg hover:opacity-80">Exit Admin</button>
                    <button onclick="app.openPostModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-lg">+ New Post</button>
                </div>
            </div>

            <!-- Admin Tabs -->
            <div class="flex gap-4 border-b border-slate-300 dark:border-slate-700 mb-6">
                <button onclick="app.switchAdminTab('posts')" class="pb-2 border-b-2 border-blue-600 font-semibold px-2">Posts</button>
                <button onclick="app.switchAdminTab('settings')" class="pb-2 border-transparent text-slate-500 hover:text-slate-800 dark:hover:text-white px-2">Settings</button>
            </div>

            <!-- Admin Posts List -->
            <div id="admin-posts-tab" class="overflow-x-auto bg-white dark:bg-slate-800 rounded-xl shadow-sm">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-300 uppercase">
                        <tr>
                            <th class="p-4">Title</th>
                            <th class="p-4">Type</th>
                            <th class="p-4">Score</th>
                            <th class="p-4">Status</th>
                            <th class="p-4 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="admin-posts-table-body" class="divide-y divide-slate-100 dark:divide-slate-700">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>

            <!-- Admin Settings Tab -->
            <div id="admin-settings-tab" class="hidden max-w-2xl bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm">
                <form id="settings-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Site Name</label>
                        <input type="text" name="siteName" class="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Hero Title</label>
                        <input type="text" name="heroTitle" class="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Hero Subtitle</label>
                        <input type="text" name="heroSubtitle" class="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Primary Theme Color</label>
                        <select name="primaryTheme" class="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600">
                            <option value="blue">Blue</option>
                            <option value="emerald">Emerald</option>
                            <option value="indigo">Indigo</option>
                            <option value="rose">Rose</option>
                            <option value="amber">Amber</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Allowed Admin Email (Be Careful)</label>
                        <input type="email" name="allowedAdminEmail" class="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600">
                    </div>
                    <button type="submit" class="w-full py-2 bg-green-600 text-white rounded hover:bg-green-700">Save Settings</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Main Content (Public) -->
    <main id="public-view" class="pt-24 pb-12 px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto min-h-screen">
        
        <!-- Hero -->
        <div class="text-center mb-12 animate-fade-in">
            <h1 id="hero-title" class="text-4xl md:text-6xl font-extrabold tracking-tight mb-4 bg-clip-text text-transparent bg-gradient-to-r from-slate-900 to-slate-600 dark:from-white dark:to-slate-400">
                Discover Excellence
            </h1>
            <p id="hero-subtitle" class="text-lg text-slate-600 dark:text-slate-400 max-w-2xl mx-auto">
                Curated Alpha Posts & AI Tools for the modern professional.
            </p>
        </div>

        <!-- Filters -->
        <div class="sticky top-16 z-30 bg-slate-50/90 dark:bg-slate-950/90 backdrop-blur py-4 mb-8 border-b border-slate-200 dark:border-slate-800">
            <div class="flex flex-col gap-4">
                <!-- Top Row: Search (Mobile), Type Filter, Category -->
                <div class="flex flex-wrap items-center justify-center gap-3">
                    <div class="md:hidden w-full mb-2">
                        <input type="text" id="mobile-search" placeholder="Search..." class="w-full p-2 rounded border dark:bg-slate-800 dark:border-slate-700">
                    </div>

                    <!-- Type Tabs -->
                    <div class="bg-slate-200 dark:bg-slate-800 p-1 rounded-lg inline-flex">
                        <button onclick="app.setFilter('type', 'all')" class="filter-type-btn px-4 py-1.5 rounded-md text-sm font-medium transition active-filter" data-val="all">All</button>
                        <button onclick="app.setFilter('type', 'alpha')" class="filter-type-btn px-4 py-1.5 rounded-md text-sm font-medium transition" data-val="alpha">Alpha</button>
                        <button onclick="app.setFilter('type', 'tool')" class="filter-type-btn px-4 py-1.5 rounded-md text-sm font-medium transition" data-val="tool">AI Tools</button>
                    </div>

                    <!-- Category Dropdown -->
                    <select id="category-filter" onchange="app.setFilter('category', this.value)" class="p-2 pr-8 rounded-lg bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-sm focus:ring-2 focus:ring-blue-500">
                        <option value="all">All Categories</option>
                        <!-- Populated dynamically -->
                    </select>
                </div>

                <!-- Score Range -->
                <div class="flex flex-wrap justify-center gap-2">
                    <button onclick="app.setFilter('score', 'all')" class="filter-score-btn px-3 py-1 rounded-full border border-slate-300 dark:border-slate-700 text-xs font-semibold active-score" data-val="all">Any Score</button>
                    <button onclick="app.setFilter('score', '81-100')" class="filter-score-btn px-3 py-1 rounded-full border border-slate-300 dark:border-slate-700 text-xs hover:bg-slate-100 dark:hover:bg-slate-800 transition" data-val="81-100">81-100</button>
                    <button onclick="app.setFilter('score', '61-80')" class="filter-score-btn px-3 py-1 rounded-full border border-slate-300 dark:border-slate-700 text-xs hover:bg-slate-100 dark:hover:bg-slate-800 transition" data-val="61-80">61-80</button>
                    <button onclick="app.setFilter('score', '41-60')" class="filter-score-btn px-3 py-1 rounded-full border border-slate-300 dark:border-slate-700 text-xs hover:bg-slate-100 dark:hover:bg-slate-800 transition" data-val="41-60">41-60</button>
                    <button onclick="app.setFilter('score', '0-40')" class="filter-score-btn px-3 py-1 rounded-full border border-slate-300 dark:border-slate-700 text-xs hover:bg-slate-100 dark:hover:bg-slate-800 transition" data-val="0-40">0-40</button>
                </div>
            </div>
        </div>

        <!-- Grid -->
        <div id="posts-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Skeletons (Initial) -->
            <div class="h-80 bg-slate-200 dark:bg-slate-800 rounded-xl animate-pulse"></div>
            <div class="h-80 bg-slate-200 dark:bg-slate-800 rounded-xl animate-pulse"></div>
            <div class="h-80 bg-slate-200 dark:bg-slate-800 rounded-xl animate-pulse"></div>
        </div>
        
        <div id="empty-state" class="hidden text-center py-20">
            <i class="fa-regular fa-folder-open text-6xl text-slate-300 mb-4"></i>
            <p class="text-xl text-slate-500">No results found.</p>
        </div>

    </main>

    <!-- Post Details Modal -->
    <div id="post-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
        <div class="bg-white dark:bg-slate-900 w-full max-w-4xl max-h-[90vh] rounded-2xl shadow-2xl overflow-hidden flex flex-col relative animate-fade-in">
            <button onclick="app.closeModals()" class="absolute top-4 right-4 z-10 bg-black/20 hover:bg-black/40 text-white rounded-full p-2 w-10 h-10 backdrop-blur">
                <i class="fa-solid fa-xmark"></i>
            </button>
            <div class="overflow-y-auto custom-scrollbar flex-1">
                <div class="relative h-64 md:h-80 w-full">
                    <img id="modal-img" src="" class="w-full h-full object-cover">
                    <div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-black/80 to-transparent p-6 pt-20">
                        <div class="flex items-center gap-3 mb-2">
                            <span id="modal-type" class="px-2 py-0.5 rounded text-xs uppercase font-bold tracking-wider bg-white text-black"></span>
                            <span id="modal-score" class="px-2 py-0.5 rounded text-xs font-bold bg-yellow-500 text-black"></span>
                        </div>
                        <h2 id="modal-title" class="text-3xl font-bold text-white"></h2>
                    </div>
                </div>
                <div class="p-6 md:p-8">
                    <div class="flex flex-wrap gap-2 mb-6" id="modal-tags"></div>
                    <p id="modal-desc" class="text-lg text-slate-600 dark:text-slate-300 font-medium mb-6 leading-relaxed"></p>
                    <div id="modal-content" class="prose dark:prose-invert max-w-none text-slate-700 dark:text-slate-400 mb-8 whitespace-pre-wrap"></div>
                    
                    <div class="flex gap-4 pt-4 border-t border-slate-200 dark:border-slate-800">
                        <a id="modal-link" href="#" target="_blank" class="flex-1 text-center bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-semibold transition shadow-lg shadow-blue-500/20">
                            Visit Resource <i class="fa-solid fa-external-link-alt ml-2"></i>
                        </a>
                        <button onclick="app.sharePost()" class="px-6 py-3 bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 rounded-xl font-semibold hover:bg-slate-200 dark:hover:bg-slate-700 transition">
                            <i class="fa-solid fa-share-nodes"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="auth-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white dark:bg-slate-900 w-full max-w-md rounded-2xl shadow-2xl p-8 relative animate-fade-in">
            <button onclick="app.closeModals()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 dark:hover:text-white">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>
            <h2 class="text-2xl font-bold mb-6 text-center">Welcome Back</h2>
            <form id="auth-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Email</label>
                    <input type="email" id="auth-email" required class="w-full p-3 rounded-lg border border-slate-300 dark:border-slate-700 dark:bg-slate-800 focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Password</label>
                    <input type="password" id="auth-pass" required class="w-full p-3 rounded-lg border border-slate-300 dark:border-slate-700 dark:bg-slate-800 focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <button type="submit" class="w-full py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition shadow-lg">
                    Login / Register
                </button>
            </form>
            <p class="mt-4 text-xs text-center text-slate-500">
                If the account doesn't exist, we will create one automatically.
            </p>
            <div id="auth-user-info" class="hidden text-center mt-6">
                <p class="text-lg font-medium mb-2">Logged in as <span id="user-email-display" class="text-blue-500"></span></p>
                <button onclick="app.logout()" class="text-red-500 hover:underline">Sign Out</button>
            </div>
        </div>
    </div>

    <!-- Admin Post Editor Modal -->
    <div id="editor-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white dark:bg-slate-900 w-full max-w-2xl max-h-[90vh] rounded-2xl shadow-2xl overflow-hidden flex flex-col relative animate-fade-in">
            <div class="p-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-800">
                <h3 class="font-bold text-lg" id="editor-title">Create/Edit Post</h3>
                <button onclick="app.closeModals()" class="text-slate-500 hover:text-red-500"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="overflow-y-auto p-6 flex-1">
                <form id="post-form" class="space-y-4">
                    <input type="hidden" name="id">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Type</label>
                            <select name="type" class="w-full p-2 border rounded dark:bg-slate-800 dark:border-slate-700">
                                <option value="alpha">Alpha Post</option>
                                <option value="tool">AI Tool</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Score (0-100)</label>
                            <input type="number" name="score" min="0" max="100" class="w-full p-2 border rounded dark:bg-slate-800 dark:border-slate-700">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Title</label>
                        <input type="text" name="title" required class="w-full p-2 border rounded dark:bg-slate-800 dark:border-slate-700">
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Category</label>
                        <input type="text" name="category" placeholder="e.g. Finance, Coding" list="cat-list" required class="w-full p-2 border rounded dark:bg-slate-800 dark:border-slate-700">
                        <datalist id="cat-list"></datalist>
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Image</label>
                        <input type="file" id="img-upload" accept="image/*" class="w-full text-sm">
                        <input type="hidden" name="imageUrl">
                        <div id="img-preview" class="mt-2 h-20 w-20 bg-slate-100 rounded bg-cover bg-center hidden"></div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Short Description</label>
                        <textarea name="description" rows="2" class="w-full p-2 border rounded dark:bg-slate-800 dark:border-slate-700"></textarea>
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Content (Markdown-ish)</label>
                        <textarea name="content" rows="6" class="w-full p-2 border rounded dark:bg-slate-800 dark:border-slate-700 font-mono text-sm"></textarea>
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase text-slate-500 mb-1">External Link</label>
                        <input type="url" name="socialLink" class="w-full p-2 border rounded dark:bg-slate-800 dark:border-slate-700">
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Tags (comma separated)</label>
                        <input type="text" name="tags" placeholder="tech, ai, crypto" class="w-full p-2 border rounded dark:bg-slate-800 dark:border-slate-700">
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" name="published" id="pub-check" class="w-5 h-5">
                        <label for="pub-check">Published (Visible to public)</label>
                    </div>
                    <div class="pt-4 flex gap-3">
                        <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700">Save Post</button>
                        <button type="button" id="delete-btn" class="hidden px-4 py-2 bg-red-100 text-red-600 rounded hover:bg-red-200">Delete</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- JS LOGIC -->
    <script type="module">
        // ==========================================
        // CONFIGURATION (REPLACE WITH YOUR KEYS)
        // ==========================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp, where } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // 1. Paste Firebase Config Here
       const firebaseConfig = {
  apiKey: "AIzaSyCrlPPqqPjMJTvMWnDxlrQ9F1i8QCWXh44",
  authDomain: "x-pro-libraryb.firebaseapp.com",
  projectId: "x-pro-libraryb",
  storageBucket: "x-pro-libraryb.firebasestorage.app",
  messagingSenderId: "550613022642",
  appId: "1:550613022642:web:77468592649f680db796ab"
};

        // 2. ImageKit Config (Public only)
        const IK_PUBLIC_KEY = 
const IK_URL_ENDPOINT = 
const IK_AUTH_ENDPOINT = 


        // Initialize Firebase
        const fbApp = initializeApp(firebaseConfig);
        const auth = getAuth(fbApp);
        const db = getFirestore(fbApp);

        // Initialize ImageKit
        const imagekit = new window.ImageKit({
            publicKey: IK_PUBLIC_KEY,
            urlEndpoint: IK_URL_ENDPOINT,
            authenticationEndpoint: IK_AUTH_ENDPOINT
        });

        // ==========================================
        // STATE & VARIABLES
        // ==========================================
        const state = {
            user: null,
            isAdmin: false,
            settings: {
                siteName: "X Pro Library",
                heroTitle: "Discover Excellence",
                primaryTheme: "blue",
                allowedAdminEmail: ""
            },
            posts: [],
            filters: {
                search: "",
                type: "all",
                category: "all",
                scoreRange: "all"
            },
            categories: new Set()
        };

        // ==========================================
        // DOM ELEMENTS
        // ==========================================
        const els = {
            toast: document.getElementById('toast-container'),
            grid: document.getElementById('posts-grid'),
            empty: document.getElementById('empty-state'),
            modals: {
                post: document.getElementById('post-modal'),
                auth: document.getElementById('auth-modal'),
                editor: document.getElementById('editor-modal')
            },
            filters: {
                typeBtns: document.querySelectorAll('.filter-type-btn'),
                scoreBtns: document.querySelectorAll('.filter-score-btn'),
                category: document.getElementById('category-filter'),
                searchGlobal: document.getElementById('global-search'),
                searchMobile: document.getElementById('mobile-search')
            },
            admin: {
                btn: document.getElementById('admin-panel-btn'),
                view: document.getElementById('admin-view'),
                publicView: document.getElementById('public-view'),
                postsBody: document.getElementById('admin-posts-table-body'),
                tabs: { posts: document.getElementById('admin-posts-tab'), settings: document.getElementById('admin-settings-tab') }
            }
        };

        // ==========================================
        // HELPER FUNCTIONS
        // ==========================================
        const showToast = (msg, type = 'info') => {
            const el = document.createElement('div');
            const colors = type === 'error' ? 'bg-red-500' : 'bg-slate-800 dark:bg-slate-700';
            el.className = `${colors} text-white px-4 py-3 rounded shadow-lg transform transition-all translate-y-2 opacity-0 text-sm font-medium`;
            el.innerText = msg;
            els.toast.appendChild(el);
            setTimeout(() => el.classList.remove('translate-y-2', 'opacity-0'), 10);
            setTimeout(() => {
                el.classList.add('opacity-0');
                setTimeout(() => el.remove(), 300);
            }, 3000);
        };

        const debounce = (func, wait) => {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        };

        const getThemeColor = (color) => {
            const map = { blue:'text-blue-600', emerald:'text-emerald-600', indigo:'text-indigo-600', rose:'text-rose-600', amber:'text-amber-600' };
            return map[color] || 'text-blue-600';
        };

        // ==========================================
        // CORE LOGIC (APP OBJECT)
        // ==========================================
        window.app = {
            init: async () => {
                // Load LocalStorage Theme
                if(localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    document.documentElement.classList.add('dark');
                }
                
                // Realtime Listeners
                app.listenSettings();
                app.listenPosts();
                
                // Event Listeners
                document.getElementById('theme-toggle').onclick = app.toggleTheme;
                document.getElementById('auth-btn').onclick = () => app.openModal('auth');
                document.getElementById('admin-panel-btn').onclick = app.openAdmin;
                document.getElementById('auth-form').onsubmit = app.handleAuth;
                document.getElementById('post-form').onsubmit = app.savePost;
                document.getElementById('delete-btn').onclick = app.deletePost;
                document.getElementById('img-upload').onchange = app.handleImagePreview;
                
                els.filters.searchGlobal.oninput = debounce((e) => app.setFilter('search', e.target.value), 300);
                els.filters.searchMobile.oninput = debounce((e) => app.setFilter('search', e.target.value), 300);

                // Auth State
                onAuthStateChanged(auth, (user) => {
                    state.user = user;
                    app.checkAdminAccess();
                    app.updateAuthUI();
                });
            },

            // --- THEME ---
            toggleTheme: () => {
                const isDark = document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
            },

            // --- AUTH ---
            handleAuth: async (e) => {
                e.preventDefault();
                const email = document.getElementById('auth-email').value;
                const pass = document.getElementById('auth-pass').value;
                try {
                    await signInWithEmailAndPassword(auth, email, pass);
                    showToast('Welcome back!');
                } catch (err) {
                    try {
                        await createUserWithEmailAndPassword(auth, email, pass);
                        showToast('Account created!');
                    } catch (regErr) {
                        showToast(regErr.message, 'error');
                    }
                }
                app.closeModals();
            },
            logout: () => {
                signOut(auth);
                app.closeModals();
                showToast('Logged out');
                window.location.reload(); // clear admin state
            },
            updateAuthUI: () => {
                const btn = document.getElementById('auth-btn');
                const modalInfo = document.getElementById('auth-user-info');
                const modalForm = document.getElementById('auth-form');
                if(state.user) {
                    btn.innerText = 'Account';
                    modalForm.classList.add('hidden');
                    modalInfo.classList.remove('hidden');
                    document.getElementById('user-email-display').innerText = state.user.email;
                } else {
                    btn.innerText = 'Sign In';
                    modalForm.classList.remove('hidden');
                    modalInfo.classList.add('hidden');
                }
            },
            checkAdminAccess: () => {
                if(state.user && state.settings.allowedAdminEmail && state.user.email === state.settings.allowedAdminEmail) {
                    state.isAdmin = true;
                    els.admin.btn.classList.remove('hidden');
                } else {
                    state.isAdmin = false;
                    els.admin.btn.classList.add('hidden');
                    if(!els.admin.view.classList.contains('hidden')) app.closeAdmin();
                }
            },

            // --- FIRESTORE DATA ---
            listenSettings: () => {
                onSnapshot(doc(db, "settings", "app"), (docSnap) => {
                    if (docSnap.exists()) {
                        state.settings = docSnap.data();
                        app.applySettings();
                        app.checkAdminAccess();
                    } else {
                        // First run: Create default settings if missing (requires temp open rules or manual creation)
                        // This block is just for safety, admin usually creates this first manually.
                    }
                });
            },
            applySettings: () => {
                document.getElementById('nav-logo').innerText = state.settings.siteName;
                document.getElementById('hero-title').innerText = state.settings.heroTitle;
                document.getElementById('hero-subtitle').innerText = state.settings.heroSubtitle;
                
                // Dynamic theme color application (simple implementation)
                const logo = document.getElementById('nav-logo');
                logo.className = `text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-${state.settings.primaryTheme}-600 to-purple-600`;
                
                // Update Admin Form values
                const f = document.getElementById('settings-form');
                f.siteName.value = state.settings.siteName;
                f.heroTitle.value = state.settings.heroTitle;
                f.heroSubtitle.value = state.settings.heroSubtitle;
                f.primaryTheme.value = state.settings.primaryTheme;
                f.allowedAdminEmail.value = state.settings.allowedAdminEmail;
                
                f.onsubmit = async (e) => {
                    e.preventDefault();
                    if(!state.isAdmin) return;
                    const data = Object.fromEntries(new FormData(f));
                    await setDoc(doc(db, "settings", "app"), data, {merge: true});
                    showToast('Settings saved');
                };
            },
            listenPosts: () => {
                const q = query(collection(db, "posts"), orderBy("createdAt", "desc"));
                onSnapshot(q, (snapshot) => {
                    state.posts = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                    app.extractCategories();
                    app.renderGrid();
                    if(state.isAdmin) app.renderAdminTable();
                });
            },
            extractCategories: () => {
                state.categories = new Set(state.posts.map(p => p.category).filter(Boolean));
                const sel = els.filters.category;
                sel.innerHTML = '<option value="all">All Categories</option>';
                state.categories.forEach(c => {
                    sel.innerHTML += `<option value="${c}">${c}</option>`;
                });
                sel.innerHTML += `<datalist id="cat-list">${[...state.categories].map(c => `<option value="${c}">`).join('')}</datalist>`;
            },

            // --- FILTERING ---
            setFilter: (key, val) => {
                state.filters[key] = val;
                
                // Update UI Active States
                if(key === 'type') {
                    els.filters.typeBtns.forEach(b => {
                        b.classList.toggle('bg-white', b.dataset.val === val);
                        b.classList.toggle('shadow-sm', b.dataset.val === val);
                        b.classList.toggle('text-blue-600', b.dataset.val === val);
                    });
                }
                if(key === 'score') {
                    els.filters.scoreBtns.forEach(b => {
                        const active = b.dataset.val === val;
                        b.classList.toggle('bg-slate-800', active);
                        b.classList.toggle('text-white', active);
                        b.classList.toggle('border-transparent', active);
                    });
                }
                app.renderGrid();
            },
            filterPosts: () => {
                return state.posts.filter(p => {
                    // Public visibility check
                    if(!p.published && !state.isAdmin) return false;

                    // Search
                    if(state.filters.search) {
                        const term = state.filters.search.toLowerCase();
                        const match = (p.title + p.description + p.tags.join(' ')).toLowerCase();
                        if(!match.includes(term)) return false;
                    }
                    // Type
                    if(state.filters.type !== 'all' && p.type !== state.filters.type) return false;
                    // Category
                    if(state.filters.category !== 'all' && p.category !== state.filters.category) return false;
                    // Score
                    if(state.filters.scoreRange !== 'all') {
                        const [min, max] = state.filters.scoreRange.split('-').map(Number);
                        if(p.score < min || p.score > max) return false;
                    }
                    return true;
                });
            },

            // --- RENDERING ---
            renderGrid: () => {
                const filtered = app.filterPosts();
                els.grid.innerHTML = '';
                
                if(filtered.length === 0) {
                    els.empty.classList.remove('hidden');
                    return;
                }
                els.empty.classList.add('hidden');

                filtered.forEach(p => {
                    const card = document.createElement('div');
                    card.className = "bg-white dark:bg-slate-900 rounded-xl overflow-hidden shadow-sm hover:shadow-xl transition duration-300 border border-slate-100 dark:border-slate-800 group flex flex-col h-full";
                    
                    // Card Logic
                    const badgeColor = p.type === 'alpha' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700';
                    const scoreColor = p.score >= 80 ? 'bg-green-100 text-green-700' : (p.score >= 50 ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700');

                    card.innerHTML = `
                        <div class="relative h-48 overflow-hidden cursor-pointer" onclick="app.openPostDetails('${p.id}')">
                            <img src="${p.imageUrl || 'https://via.placeholder.com/400x300?text=No+Image'}" class="w-full h-full object-cover group-hover:scale-105 transition duration-500">
                            <div class="absolute top-2 left-2 flex gap-1">
                                <span class="px-2 py-1 rounded-md text-xs font-bold uppercase ${badgeColor}">${p.type}</span>
                            </div>
                            <div class="absolute top-2 right-2">
                                <span class="px-2 py-1 rounded-md text-xs font-bold ${scoreColor}">${p.score}</span>
                            </div>
                        </div>
                        <div class="p-5 flex flex-col flex-1">
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-xs text-slate-400 font-semibold uppercase tracking-wider">${p.category}</span>
                            </div>
                            <h3 class="text-xl font-bold mb-2 group-hover:text-blue-600 transition cursor-pointer" onclick="app.openPostDetails('${p.id}')">${p.title}</h3>
                            <p class="text-slate-500 text-sm line-clamp-3 mb-4 flex-1">${p.description}</p>
                            <div class="pt-4 border-t border-slate-100 dark:border-slate-800 flex items-center justify-between">
                                <div class="flex gap-2 overflow-hidden w-2/3">
                                    ${(p.tags||[]).slice(0,2).map(t => `<span class="text-xs bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded text-slate-500">#${t}</span>`).join('')}
                                </div>
                                <button onclick="app.openPostDetails('${p.id}')" class="text-blue-600 hover:text-blue-700 text-sm font-semibold">View <i class="fa-solid fa-arrow-right ml-1"></i></button>
                            </div>
                        </div>
                    `;
                    els.grid.appendChild(card);
                });
            },

            // --- MODALS ---
            openModal: (id) => {
                document.querySelectorAll('[id$="-modal"]').forEach(m => m.classList.add('hidden'));
                els.modals[id].classList.remove('hidden');
            },
            closeModals: () => {
                document.querySelectorAll('[id$="-modal"]').forEach(m => m.classList.add('hidden'));
            },
            openPostDetails: (id) => {
                const p = state.posts.find(x => x.id === id);
                if(!p) return;
                
                const m = els.modals.post;
                m.querySelector('#modal-img').src = p.imageUrl || '';
                m.querySelector('#modal-title').innerText = p.title;
                m.querySelector('#modal-desc').innerText = p.description;
                m.querySelector('#modal-content').innerText = p.content;
                m.querySelector('#modal-type').innerText = p.type;
                m.querySelector('#modal-score').innerText = `Score: ${p.score}`;
                m.querySelector('#modal-tags').innerHTML = (p.tags||[]).map(t => `<span class="bg-slate-200 dark:bg-slate-700 px-2 py-1 rounded text-xs font-bold text-slate-600 dark:text-slate-300">#${t}</span>`).join('');
                
                const linkBtn = m.querySelector('#modal-link');
                if(p.socialLink) {
                    linkBtn.href = p.socialLink;
                    linkBtn.classList.remove('hidden');
                } else {
                    linkBtn.classList.add('hidden');
                }

                // Copy Link Handler
                app.currentShareLink = window.location.origin + '?post=' + p.id; 
                
                app.openModal('post');
            },
            sharePost: () => {
                navigator.clipboard.writeText(app.currentShareLink || window.location.href);
                showToast('Link copied to clipboard!');
            },

            // --- ADMIN LOGIC ---
            openAdmin: () => {
                els.admin.view.classList.remove('hidden');
                els.admin.publicView.classList.add('hidden');
                window.scrollTo(0,0);
                app.renderAdminTable();
            },
            closeAdmin: () => {
                els.admin.view.classList.add('hidden');
                els.admin.publicView.classList.remove('hidden');
            },
            switchAdminTab: (tab) => {
                els.admin.tabs.posts.classList.toggle('hidden', tab !== 'posts');
                els.admin.tabs.settings.classList.toggle('hidden', tab !== 'settings');
            },
            renderAdminTable: () => {
                const tbody = els.admin.postsBody;
                tbody.innerHTML = '';
                state.posts.forEach(p => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-slate-50 dark:hover:bg-slate-700 border-b border-slate-100 dark:border-slate-700";
                    tr.innerHTML = `
                        <td class="p-4 font-medium dark:text-white">${p.title}</td>
                        <td class="p-4"><span class="px-2 py-1 rounded text-xs bg-slate-100 dark:bg-slate-600">${p.type}</span></td>
                        <td class="p-4">${p.score}</td>
                        <td class="p-4"><span class="w-2 h-2 inline-block rounded-full ${p.published ? 'bg-green-500' : 'bg-red-500'}"></span></td>
                        <td class="p-4 text-right">
                            <button class="text-blue-600 hover:underline mr-2" onclick="app.openPostModal('${p.id}')">Edit</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            },
            openPostModal: (id = null) => {
                const form = document.getElementById('post-form');
                form.reset();
                document.getElementById('img-preview').classList.add('hidden');
                document.getElementById('delete-btn').classList.add('hidden');
                document.getElementById('editor-title').innerText = "Create New Post";

                if(id) {
                    const p = state.posts.find(x => x.id === id);
                    if(p) {
                        document.getElementById('editor-title').innerText = "Edit Post";
                        form.id.value = p.id;
                        form.type.value = p.type;
                        form.title.value = p.title;
                        form.description.value = p.description;
                        form.content.value = p.content;
                        form.score.value = p.score;
                        form.category.value = p.category;
                        form.socialLink.value = p.socialLink || '';
                        form.tags.value = (p.tags || []).join(', ');
                        form.published.checked = p.published;
                        form.imageUrl.value = p.imageUrl || '';
                        if(p.imageUrl) {
                            const prev = document.getElementById('img-preview');
                            prev.classList.remove('hidden');
                            prev.style.backgroundImage = `url(${p.imageUrl})`;
                        }
                        document.getElementById('delete-btn').classList.remove('hidden');
                    }
                }
                app.openModal('editor');
            },
            handleImagePreview: async (e) => {
                const file = e.target.files[0];
                if(file) {
                    // Upload to ImageKit immediately upon selection
                    showToast('Uploading image...', 'info');
                    try {
                        const res = await new Promise((resolve, reject) => {
                            imagekit.upload({
                                file: file,
                                fileName: "xpro_" + Date.now(),
                                tags: ["xpro-library"]
                            }, (err, result) => {
                                if(err) reject(err);
                                else resolve(result);
                            });
                        });
                        
                        document.querySelector('input[name="imageUrl"]').value = res.url;
                        const prev = document.getElementById('img-preview');
                        prev.classList.remove('hidden');
                        prev.style.backgroundImage = `url(${res.url})`;
                        showToast('Image uploaded!');
                    } catch (err) {
                        console.error(err);
                        showToast('Image upload failed', 'error');
                    }
                }
            },
            savePost: async (e) => {
                e.preventDefault();
                const f = e.target;
                const id = f.id.value;
                const data = {
                    type: f.type.value,
                    title: f.title.value,
                    description: f.description.value,
                    content: f.content.value,
                    score: Number(f.score.value),
                    category: f.category.value,
                    socialLink: f.socialLink.value,
                    tags: f.tags.value.split(',').map(t => t.trim()).filter(Boolean),
                    published: f.published.checked,
                    imageUrl: f.imageUrl.value,
                    updatedAt: serverTimestamp()
                };

                try {
                    if(id) {
                        await updateDoc(doc(db, "posts", id), data);
                        showToast('Post updated');
                    } else {
                        data.createdAt = serverTimestamp();
                        await addDoc(collection(db, "posts"), data);
                        showToast('Post created');
                    }
                    app.closeModals();
                } catch (err) {
                    showToast(err.message, 'error');
                }
            },
            deletePost: async () => {
                const id = document.querySelector('#post-form input[name="id"]').value;
                if(!id || !confirm('Are you sure you want to delete this post?')) return;
                try {
                    await deleteDoc(doc(db, "posts", id));
                    showToast('Post deleted');
                    app.closeModals();
                } catch (err) {
                    showToast(err.message, 'error');
                }
            }
        };

        // Esc key to close modals
        document.addEventListener('keydown', (e) => {
            if(e.key === 'Escape') app.closeModals();
        });

        // Init App
        app.init();
    </script>
</body>

</html>

